[[upgrading]]
== Upgrade

This section gives general recommendations for upgrading {beats} shippers:

* <<upgrade-minor-versions>>
* <<upgrade-7-to-8>>
* <<troubleshooting-upgrade>>

If you're upgrading other products in the stack, also read the
{stack-ref}/index.html[Elastic Stack Installation and Upgrade Guide].

[discrete]
[[upgrade-minor-versions]]
=== Upgrade between minor versions

As a general rule, you can upgrade between minor versions (for example, 8.x to
8.y, where x < y) by simply installing the new release and restarting the Beat
process. {beats} typically maintain backwards compatibility for configuration
settings and exported fields. Please review the
<<release-notes,release notes>> for potential exceptions.

Upgrading between non-consecutive major versions (e.g. 6.x to 8.x) is not
supported.

[discrete]
[[upgrade-7-to-8]]
=== Upgrade from 7.x to 8.x

Before upgrading your {beats}, review the <<breaking-changes,breaking changes>>
and the <<release-notes>>.

If you're upgrading other products in the stack, also read the
{stack-ref}/index.html[Elastic Stack Installation and Upgrade Guide].

We recommend that you fully upgrade {es} and {kib} to version 8.0
before upgrading {beats}. The {beats} version must be lower than or equal to the
{es} version. {beats} cannot send data to older versions of {es}.

If you're on {beats} 7.0 through 7.16, upgrade the {stack} and {beats} to
version 7.17 *before* proceeding with the 8.0 upgrade.

Upgrading between non-consecutive major versions (e.g. 6.x to 8.x) is not
supported.

IMPORTANT: Please read through all upgrade steps before proceeding. These steps
are required before running the software for the first time.

[discrete]
[[upgrade-to-7.17]]
==== Upgrade to {beats} 7.17 before upgrading to 8.0

The upgrade procedure assumes that you have {beats} 7.17 installed. If you're on
a previous 7.x version of {beats}, *upgrade to version 7.17 first*. If you're
using other products in the {stack}, upgrade {beats} as part of the
{stack-ref}/upgrading-elastic-stack.html[{stack} upgrade process].

After upgrading to 7.17, go to *Index Management* in {kib} and verify
that the 7.17 index template has been loaded into {es}.

[role="screenshot"]
image::images/confirm-index-template.png[Screen capture showing that metricbeat-1.17.0 index template is loaded]

If the 7.17 index template is not loaded, load it now.

If you created custom dashboards prior to version 7.17, you must upgrade them to
7.17 before proceeding. Otherwise, the dashboards will stop working because
{kib} no longer provides the API used for dashboards in 7.x.

<<<<<<< HEAD
NOTE: In previous versions, we advised users to manually force loading of the
index template. This is no longer recommended. Use the `setup` command instead.

*Metricbeat and Filebeat users:* If you use {beats} central management,
make sure you migrate the {beats} central management index to 6.8 before you
upgrade to 7.0. Although central management is not a GA-level feature in 7.0,
we've provided a migration tool to help you migrate your configurations from
version 6.6 to 6.7 or later. For more information, see the
https://www.elastic.co/blog/beats-6-7-0-released[Beats 6.7.0 release blog].

NOTE: {beats} central management has been removed starting in version 7.14.0.
Looking for a replacement? Refer to the
{fleet-guide}/index.html[Fleet and Elastic Agent Guide] to learn how to deploy
and centrally manage a single {agent} to monitor and secure each host. 

==== Upgrade {beats} binaries to 7.0
=======
[discrete]
[[upgrade-beats-binaries]]
==== Upgrade {beats} binaries to 8.0
>>>>>>> c26cea662a (Add Beats upgrade docs for 8.0 (#30355))

Before upgrading:

. Stop the existing {beats} process by using the appropriate command for your
system.
. Back up the `data` and `config` directories by copying them to another
location.
+
TIP: The location of these directories depends on the installation method. To
see the current paths, start the Beat from a terminal, and the `data` and
`config` paths are printed at startup.

To upgrade using a Debian or RPM package:

* Use `rpm` or `dpkg` to install the new package. All files are installed in the
appropriate location for the operating system and {beats} config files are not
overwritten.

To upgrade using a zip or compressed tarball:

. Extract the zip or tarball to a _new_ directory. This is critical if you
are not using external `config` and `data` directories.
. Set the following options in the {beats} configuration file:
+
--
* Set `path.config` to point to your external `config` directory. If you are
not using an external `config` directory, copy your old configuration over to
the new installation.
* Set `path.data` to point to your external data directory. If you are not using
an external `data` directory, copy your old data directory over to the new
installation.
* Set `path.logs` to point to the location where you want to store your logs. If
you do not specify this setting, logs are stored in the directory you extracted
the archive to.
--

Complete the upgrade tasks described in the following sections *before*
restarting the {beats} process.

[discrete]
[[migrate-config-files]]
==== Migrate configuration files

{beats} 8.0 comes with several backwards incompatible configuration changes.
Before upgrading, review the <<breaking-changes-8.0>> document. Also review
the full list of breaking changes in the <<release-notes-8.0.0>>.

Where possible, we kept the old configuration options working, but deprecated
them. However, deprecation was not always possible, so if you use any of the
settings described under breaking changes, make sure you understand the
alternatives that we provide.


[discrete]
[[upgrade-index-template]]
==== Load the 8.0 {es} index templates

Starting in version 8.0, the default {es} index templates configure data streams
instead of traditional {es} indices. Data streams are optimized for storing
append-only time series data. They are well-suited for logs, events, metrics,
and other continuously generated data. However, unlike traditional {es} indices,
data streams support create operations only; they do not support update and
delete operations.

To use data streams, load the default index templates *before* ingesting any
data into {es}.

include::{libbeat-dir}/tab-widgets/load-index-template-widget.asciidoc[]

If you're not collecting time series data, you can continue to use {beats}
to send data to aliases and indices. To do this, create a custom index template
and load it manually. To learn more about creating index templates, refer to
{ref}/index-templates.html[Index templates].

[discrete]
[[load-8.0-dashboards]]
==== Load 8.0 dashboards

We recommend that you load the 8.0 {kib} dashboards after upgrading {kib} and
{beats}. That way, you can take advantage of improvements added in 8.0. To load
the dashboards, run:

include::{libbeat-dir}/tab-widgets/load-dashboards-widget.asciidoc[]


[discrete]
[[migrate-custom-dashboards]]
==== Migrate custom dashboards and visualizations

All Elastic {beats} send events with ECS-compliant field names. If you have any
custom {kib} dashboards or visualizations that use old fields, adjust them now
to use ECS field names.

To learn more about ECS, refer to the {ecs-ref}/ecs-reference.html[ECS overview].

NOTE: If you enabled the compatibility layer in 7.x (that is, if you set
`migration.6_to_7.enabled: true`), make sure your custom dashboards no longer
rely on the old aliases created by that setting. The old aliases are no longer
supported. They may continue to work, but will be removed without notice in
a future release.

[discrete]
[[start-beats]]
==== Start your upgraded {beats}

After you've completed the migration, start the upgraded Beat. Use the command
that works with your system.

Check the console and logs for errors.

In {kib}, go to *Discover* and verify that events are streaming into {es}.

[discrete]
[[troubleshooting-upgrade]]
=== Troubleshoot {beats} upgrade issues

This section describes common problems you might encounter when upgrading to
{beats} 8.x.

You can avoid some of these problems by reading <<upgrade-7-to-8>> before
upgrading {beats}.

[discrete]
[[unable-to-update-or-delete]]
==== {beats} is unable to send update or deletion requests to a data stream

Data streams are designed for use cases where existing data is rarely, if ever,
updated. You cannot send update or deletion requests for existing documents
directly to a data stream.

If needed, you can update or delete documents by submitting requests directly to
the documentâ€™s backing index. To learn how, refer to the docs about
{ref}/use-a-data-stream.html[using a data stream].

[discrete]
[[missing-timestamp-field]]
==== Timestamp field is missing

{beats} requires a timestamp field to send data to data streams. If the
timestamp field added by {beats} is inadvertently removed by a processor, {beats}
will be unable to index the event. To fix the problem, modify your processor
configuration to avoid removing the timestamp field.

[discrete]
[[missing-fields]]
==== Missing fields or too many fields in the index

You may have run the Beat before loading the required index template. To clean
up and start again:

. Delete the index that was created when you ran the Beat. For example:
+
["source","sh",subs="attributes"]
----
DELETE metricbeat-{version}-2019.04.02*
----
+
WARNING: Be careful when using wildcards to delete indices. Make sure the
pattern matches only the indices you want to delete. The example shown here
deletes all data indexed into the metricbeat-{version} indices on
2019.04.02.

. Delete the index template that was loaded earlier. For example:
+
["source","sh",subs="attributes"]
----
DELETE /_index_template/metricbeat-{version}
----

. Load the correct index template. See <<upgrade-index-template>>.

. Restart {beats}.
<<<<<<< HEAD

[[user-unauthorized]]
==== User is not authorized

Because index lifecycle management is on by default in 7.0, you might encounter
new errors related to user authorization when you run version 7.0 against an
{es} cluster that supports index lifecycle management.

===== `[cluster:monitor/main] is unauthorized for user`

*Problem*: The {beats} user is unable to send monitoring information.

*Solution:* Grant the `monitor` cluster privilege.

===== `[cluster:admin/ilm/put] is unauthorized for user`

*Problem:* The {beats} user is not authorized to load ILM policies.

*Solution:* Grant the `manage_ilm` cluster privilege.

===== `[indices:admin/template/put] is unauthorized for user`

*Problem:* Automatic index template loading is required when ILM is enabled, but the user
is not authorized to manage index templates.

*Solution:* Grant the `manage_index_templates` cluster privilege.

===== `[indices:admin/aliases] is unauthorized for user`

*Problem:* The {beats} user is unable to set up aliases needed by the compatibility
layer.

*Solution:* Grant the `manage` privilege on the {beats} indices.

===== `[indices:data/write/bulk] is unauthorized for user`

*Problem:*  The {beats} user is unable to write events to {es}.

*Solution:* Grant the `index` privilege on the {beats} indices.

[[old-dashboards-failing]]
==== 6.x dashboards not showing data from 7.0 shippers

You might have run the Beat without turning on the compatibility layer. See
<<enable-ecs-compatibility>> then clean up your environment as described
under <<missing-fields>>.

[[logstash-data-missing]]
==== Data parsed by {ls} not appearing in 7.0 dashboards

You might be writing to an index that doesn't match the index pattern used
by {beats}. See <<non-es-outputs>>.


[[dashboard-shard-failed]]
==== "shard failed" error when viewing {beats} dashboards in {kib}

After upgrading to {es} 7.0, any indices created by Beats 6.6 or older will not
work in {kib} dashboards until the `index.query.default_field` setting is added
to each index. Indices created in Beats 6.7 or later are unaffected.

*Background:* Starting in {es} 7.0, some query types, such as Simple Query
String, have a limit to the number of fields they will query against. Because
Beats indices often contain more fields than this cap, the
`index.query.default_field` index setting is used to inform {es} which fields to
use by default when no field is specified for a query.

To add the setting to the index, you can use the 7.0
{kibana-ref}/upgrade-assistant.html[Upgrade Assistant], or add the setting
manually.

To add the setting manually, first identify the list of fields that you want to
set as the default search fields, then specify the list of fields in the
`default_field` setting.

For example, here's a snippet that shows how to add default search fields to a
Metricbeat 6.6 index. This example is truncated. Full examples for Metricbeat
and Filebeat are available in
https://github.com/elastic/beats/blob/master/libbeat/docs/troubleshooting/default_field.md[this file].

[source,js]
--------------------------------------------------
PUT /metricbeat-6.6.2-2019.04.09/_settings
{
  "index": {
    "query": {
      "default_field": [
        "aerospike.namespace.name",
        "aerospike.namespace.node.host",
        "aerospike.namespace.node.name",
        "apache.status.hostname",
        "beat.hostname",
        "beat.name",
        "beat.timezone",
        "beat.version",
        ...
      ]
    }
  }
}
--------------------------------------------------
// CONSOLE

/////
=======
>>>>>>> c26cea662a (Add Beats upgrade docs for 8.0 (#30355))
