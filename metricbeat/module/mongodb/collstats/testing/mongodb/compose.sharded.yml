version: "3.8"

x-mongo-image: &mongo_image ${MONGO_IMAGE:-mongo}:${MONGO_VERSION:-7.0}

services:
  config1:
    image: *mongo_image
    command: ["mongod", "--configsvr", "--replSet", "cfgRS", "--port", "27019", "--bind_ip_all"]
    ports: ["27019"]
    volumes: ["config1:/data/db"]
  config2:
    image: *mongo_image
    command: ["mongod", "--configsvr", "--replSet", "cfgRS", "--port", "27019", "--bind_ip_all"]
    volumes: ["config2:/data/db"]
  config3:
    image: *mongo_image
    command: ["mongod", "--configsvr", "--replSet", "cfgRS", "--port", "27019", "--bind_ip_all"]
    volumes: ["config3:/data/db"]

  shard1:
    image: *mongo_image
    command: ["mongod", "--shardsvr", "--replSet", "shard01", "--port", "27018", "--bind_ip_all"]
    volumes: ["shard1:/data/db"]
  shard2:
    image: *mongo_image
    command: ["mongod", "--shardsvr", "--replSet", "shard02", "--port", "27018", "--bind_ip_all"]
    volumes: ["shard2:/data/db"]

  mongos:
    image: *mongo_image
    depends_on:
      - config1
      - config2
      - config3
      - shard1
      - shard2
    command: ["mongos", "--configdb", "cfgRS/config1:27019,config2:27019,config3:27019", "--bind_ip_all"]
    ports:
      - "27017:27017"

volumes:
  config1:
  config2:
  config3:
  shard1:
  shard2:
