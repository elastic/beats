default: true
input:
  module: http
  metricset: json
  defaults:
    method: POST
    namespace: "json_namespace"
    basepath: "/request"
    headers:
      Content-Type: application/json
    query:
      wait: "1"
    body: '{"prefix": "osd tree", "format": "json"}'

processors:
  - extract_array:
      field: http.json_namespace.finished
      mappings:
        ceph.request: 0
  - decode_json_fields:
      fields: ["ceph.request.outb"]
      process_array: true
      target: "ceph.mgr_osd_tree"
  - drop_fields:
      ignore_missing: true
      fields: ["http", "ceph.request"]
  - script:
      lang: javascript
      source: >
        function process(event) {
          var nodes = event.Get("ceph.mgr_osd_tree.nodes")
          if (nodes != null) {
            var filtered = [];
            nodes.forEach(function(node, index) {
              if (node["pool_weights"] !== undefined) {
                delete node["pool_weights"];
              }
              filtered.push(node);
            });
            event.Put("ceph.mgr_osd_tree.nodes", filtered);
          }

          var stray = event.Get("ceph.mgr_osd_tree.stray")
          if (stray != null) {
            var filtered = [];
            stray.forEach(function(node, index) {
              if (node["pool_weights"] !== undefined) {
                delete node["pool_weights"];
              }
              filtered.push(node);
            });
            event.Put("ceph.mgr_osd_tree.stray", filtered);
          }
        }
