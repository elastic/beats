default: true
input:
  module: http
  metricset: json
  defaults:
    method: POST
    namespace: "json_namespace"
    basepath: "/request"
    headers:
      Content-Type: application/json
    query:
      wait: "1"
    body: '{"prefix": "osd pool stats", "format": "json"}'

processors:
  - extract_array:
      field: http.json_namespace.finished
      mappings:
        ceph.request: 0
  - decode_json_fields:
      fields: ["ceph.request.outb"]
      process_array: true
      target: "ceph.mgr_osd_pool_stats"
  - drop_fields:
      fields: ["http", "ceph.request"]
  - script:
      lang: javascript
      source: >
        function process(event) {
          var pools = event.Get("ceph.mgr_osd_pool_stats")
          if (pools != null) {
            var filtered = [];
            pools.forEach(function(pool, index) {
              if (pool["recovery"] !== undefined) {
                delete pool["recovery"];
              }
              if (pool["recovery_rate"] !== undefined) {
                delete pool["recovery_rate"];
              }
              filtered.push(pool);
            });
            event.Put("ceph.mgr_osd_pool_stats", filtered);
          }
        }
