version: '3.9'

services:
  postgresql:
    image: postgres:15
    hostname: postgresql
    environment:
      - POSTGRES_PASSWORD=password
      - POSTGRES_USER=test
      - POSTGRES_DB=test
      - POSTGRES_HOST_AUTH_METHOD=md5
      - POSTGRES_INITDB_ARGS=--auth=md5

  pgbouncer:
    image: edoburu/pgbouncer
    hostname: pgbouncer
    ports:
      - 6432:6432
    volumes:
      - ./_meta/pgbouncer.ini:/etc/pgbouncer/pgbouncer.ini
      - ./_meta/userlist.txt:/etc/pgbouncer/userlist.txt
    healthcheck:
      test: ['CMD-SHELL', 'psql -h localhost -p 6432 -U test -d pgbouncer -c "SHOW STATS"']
      interval: 15s
      timeout: 30s
      retries: 5
      start_period: 15s

  elasticsearch:
    image: elasticsearch:8.11.0
    hostname: elasticsearch
    environment:
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      - "http.host=0.0.0.0"
      - "xpack.security.enabled=false"
      - "discovery.type=single-node"
      # - "transport.host=127.0.0.1"
    ports:
      - 9200:9200

  kibana:
    image: kibana:8.11.0
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
    ports:
      - 5601:5601