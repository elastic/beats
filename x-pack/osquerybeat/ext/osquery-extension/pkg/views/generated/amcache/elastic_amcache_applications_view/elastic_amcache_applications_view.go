// Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one
// or more contributor license agreements. Licensed under the Elastic License;
// you may not use this file except in compliance with the Elastic License.

// Code generated by gentables. DO NOT EDIT.
// Source: views/elastic_amcache_applications_view.yaml

//go:build windows

package elasticamcacheapplicationsview

import (
	"fmt"
	"sync"

	"github.com/elastic/beats/v7/x-pack/osquerybeat/ext/osquery-extension/pkg/hooks"
	"github.com/elastic/beats/v7/x-pack/osquerybeat/ext/osquery-extension/pkg/logger"
)

var (
	hooksFunc    func(*hooks.HookManager)
	registerOnce sync.Once
)

func createViewHook(socket *string, log *logger.Logger, hookData any) error {
	v, ok := hookData.(*hooks.View)
	if !ok {
		return fmt.Errorf("hook data is not a view")
	}
	return v.Create(socket, log)
}

func deleteViewHook(socket *string, log *logger.Logger, hookData any) error {
	v, ok := hookData.(*hooks.View)
	if !ok {
		return fmt.Errorf("hook data is not a view")
	}
	return v.Delete(socket, log)
}

// RegisterDefaultViewHook registers only the create/delete view hook with the hook manager.
// To add extra hooks, call RegisterHooksFunc with a function that calls RegisterDefaultViewHook(hm)
// then registers additional hooks on hm.
func RegisterDefaultViewHook(hm *hooks.HookManager) {
	hm.Register(hooks.NewHook("CreateElasticAmcacheApplicationsViewView", createViewHook, deleteViewHook, View()))
}

// RegisterHooksFunc registers the hooks function for this view (optional).
// If called (e.g. from an implementation package), that function runs instead of the default.
// To add extra hooks while keeping the default view hook, pass a function that calls
// RegisterDefaultViewHook(hm) then registers additional hooks.
func RegisterHooksFunc(f func(*hooks.HookManager)) {
	registerOnce.Do(func() {
		hooksFunc = f
	})
}

// GetHooksFunc returns the registered hooks function for this view.
// Returns an error if no hooks function has been registered.
func GetHooksFunc() (func(*hooks.HookManager), error) {
	if hooksFunc == nil {
		return nil, fmt.Errorf("no hooks function registered for elastic_amcache_applications_view")
	}
	return hooksFunc, nil
}

// Result represents a row from the elastic_amcache_applications_view view.
type Result struct {
	Timestamp             int64  `osquery:"timestamp"`                // Last write time as Unix timestamp
	DateTime              string `osquery:"date_time"`                // Last write time in RFC3339
	ProgramId             string `osquery:"program_id"`               // Program identifier
	FileId                string `osquery:"file_id"`                  // File identifier
	LowerCaseLongPath     string `osquery:"lower_case_long_path"`     // Lowercase long path
	Name                  string `osquery:"name"`                     // Application or file name
	OriginalFileName      string `osquery:"original_file_name"`       // Original file name
	Publisher             string `osquery:"publisher"`                // Publisher
	Version               string `osquery:"version"`                  // Version
	BinFileVersion        string `osquery:"bin_file_version"`         // Binary file version
	BinaryType            string `osquery:"binary_type"`              // Binary type
	ProductName           string `osquery:"product_name"`             // Product name
	ProductVersion        string `osquery:"product_version"`          // Product version
	LinkDate              string `osquery:"link_date"`                // Link date
	BinProductVersion     string `osquery:"bin_product_version"`      // Binary product version
	Size                  int64  `osquery:"size"`                     // File size
	Language              int64  `osquery:"language"`                 // Language ID
	Usn                   int64  `osquery:"usn"`                      // Update sequence number
	AppxPackageFullName   string `osquery:"appx_package_full_name"`   // AppX package full name
	IsOsComponent         string `osquery:"is_os_component"`          // Is OS component flag
	AppxPackageRelativeId string `osquery:"appx_package_relative_id"` // AppX package relative ID
	FileSha1              string `osquery:"file_sha1"`                // File SHA1 hash
	ProgramInstanceId     string `osquery:"program_instance_id"`      // Program instance identifier
	InstallDate           string `osquery:"install_date"`             // Install date
	Source                string `osquery:"source"`                   // Source
	RootDirPath           string `osquery:"root_dir_path"`            // Root directory path
	HiddenArp             int64  `osquery:"hidden_arp"`               // Hidden ARP flag
	UninstallString       string `osquery:"uninstall_string"`         // Uninstall command string
	RegistryKeyPath       string `osquery:"registry_key_path"`        // Registry key path
	StoreAppType          string `osquery:"store_app_type"`           // Store app type
	InboxModernApp        string `osquery:"inbox_modern_app"`         // Inbox modern app flag
	ManifestPath          string `osquery:"manifest_path"`            // Manifest path
	PackageFullName       string `osquery:"package_full_name"`        // Package full name
	MsiPackageCode        string `osquery:"msi_package_code"`         // MSI package code
	MsiProductCode        string `osquery:"msi_product_code"`         // MSI product code
	MsiInstallDate        string `osquery:"msi_install_date"`         // MSI install date
	BundleManifestPath    string `osquery:"bundle_manifest_path"`     // Bundle manifest path
	UserSid               string `osquery:"user_sid"`                 // User SID
	AppSha1               string `osquery:"app_sha1"`                 // Application SHA1 hash
}

// View returns the view definition for elastic_amcache_applications_view.
// Combined view of amcache applications and application files (apps with optional file rows, plus file-only rows)
//
// Columns:
//   - timestamp (BIGINT): Last write time as Unix timestamp
//   - date_time (TEXT): Last write time in RFC3339
//   - program_id (TEXT): Program identifier
//   - file_id (TEXT): File identifier
//   - lower_case_long_path (TEXT): Lowercase long path
//   - name (TEXT): Application or file name
//   - original_file_name (TEXT): Original file name
//   - publisher (TEXT): Publisher
//   - version (TEXT): Version
//   - bin_file_version (TEXT): Binary file version
//   - binary_type (TEXT): Binary type
//   - product_name (TEXT): Product name
//   - product_version (TEXT): Product version
//   - link_date (TEXT): Link date
//   - bin_product_version (TEXT): Binary product version
//   - size (BIGINT): File size
//   - language (BIGINT): Language ID
//   - usn (BIGINT): Update sequence number
//   - appx_package_full_name (TEXT): AppX package full name
//   - is_os_component (TEXT): Is OS component flag
//   - appx_package_relative_id (TEXT): AppX package relative ID
//   - file_sha1 (TEXT): File SHA1 hash
//   - program_instance_id (TEXT): Program instance identifier
//   - install_date (TEXT): Install date
//   - source (TEXT): Source
//   - root_dir_path (TEXT): Root directory path
//   - hidden_arp (BIGINT): Hidden ARP flag
//   - uninstall_string (TEXT): Uninstall command string
//   - registry_key_path (TEXT): Registry key path
//   - store_app_type (TEXT): Store app type
//   - inbox_modern_app (TEXT): Inbox modern app flag
//   - manifest_path (TEXT): Manifest path
//   - package_full_name (TEXT): Package full name
//   - msi_package_code (TEXT): MSI package code
//   - msi_product_code (TEXT): MSI product code
//   - msi_install_date (TEXT): MSI install date
//   - bundle_manifest_path (TEXT): Bundle manifest path
//   - user_sid (TEXT): User SID
//   - app_sha1 (TEXT): Application SHA1 hash
func View() *hooks.View {
	return hooks.NewView(
		"elastic_amcache_applications_view",
		[]string{"elastic_amcache_application", "elastic_amcache_application_file"},
		`CREATE VIEW elastic_amcache_applications_view AS
SELECT
  COALESCE(file.timestamp, app.timestamp) AS timestamp,
  COALESCE(file.date_time, app.date_time) AS date_time,
  app.program_id,
  file.file_id,
  file.lower_case_long_path,
  COALESCE(file.name, app.name) AS name,
  file.original_file_name,
  COALESCE(file.publisher, app.publisher) AS publisher,
  COALESCE(file.version, app.version) AS version,
  file.bin_file_version,
  file.binary_type,
  file.product_name,
  file.product_version,
  file.link_date,
  file.bin_product_version,
  file.size,
  COALESCE(file.language, app.language) AS language,
  file.usn,
  file.appx_package_full_name,
  file.is_os_component,
  file.appx_package_relative_id,
  file.sha1 AS file_sha1,
  app.program_instance_id,
  app.install_date,
  app.source,
  app.root_dir_path,
  app.hidden_arp,
  app.uninstall_string,
  app.registry_key_path,
  app.store_app_type,
  app.inbox_modern_app,
  app.manifest_path,
  app.package_full_name,
  app.msi_package_code,
  app.msi_product_code,
  app.msi_install_date,
  app.bundle_manifest_path,
  app.user_sid,
  app.sha1 AS app_sha1
FROM elastic_amcache_application AS app
LEFT JOIN elastic_amcache_application_file AS file ON app.program_id = file.program_id
UNION ALL
SELECT
  file.timestamp,
  file.date_time,
  file.program_id,
  file.file_id,
  file.lower_case_long_path,
  file.name,
  file.original_file_name,
  file.publisher,
  file.version,
  file.bin_file_version,
  file.binary_type,
  file.product_name,
  file.product_version,
  file.link_date,
  file.bin_product_version,
  file.size,
  file.language,
  file.usn,
  file.appx_package_full_name,
  file.is_os_component,
  file.appx_package_relative_id,
  file.sha1 AS file_sha1,
  NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL AS app_sha1
FROM elastic_amcache_application_file AS file
LEFT JOIN elastic_amcache_application AS app ON file.program_id = app.program_id
WHERE app.program_id IS NULL;`,
	)
}
