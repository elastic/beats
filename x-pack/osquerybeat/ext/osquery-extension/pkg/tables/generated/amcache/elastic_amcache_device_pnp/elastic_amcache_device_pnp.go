// Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one
// or more contributor license agreements. Licensed under the Elastic License;
// you may not use this file except in compliance with the Elastic License.

// Code generated by gentables. DO NOT EDIT.
// Source: tables/elastic_amcache_device_pnp.yaml

//go:build windows

package elasticamcachedevicepnp

import (
	"context"
	"errors"
	"sync"

	"time"

	"github.com/osquery/osquery-go/plugin/table"

	"github.com/elastic/beats/v7/x-pack/osquerybeat/ext/osquery-extension/pkg/encoding"
	"github.com/elastic/beats/v7/x-pack/osquerybeat/ext/osquery-extension/pkg/logger"
)

var (
	generateFunc func(context.Context, table.QueryContext, *logger.Logger) ([]Result, error)
	registerOnce sync.Once
)

// RegisterGenerateFunc registers the generate function for this table.
// This should be called once from the implementation package's init() function.
func RegisterGenerateFunc(f func(context.Context, table.QueryContext, *logger.Logger) ([]Result, error)) {
	registerOnce.Do(func() {
		generateFunc = f
	})
}

// GetGenerateFunc returns the osquery table.GenerateFunc for this table.
// It wraps the registered generate function and handles marshaling of results.
func GetGenerateFunc(log *logger.Logger) (table.GenerateFunc, error) {
	if generateFunc == nil {
		return nil, errors.New("generate function not registered for elastic_amcache_device_pnp")
	}
	return func(ctx context.Context, queryContext table.QueryContext) ([]map[string]string, error) {
		results, err := generateFunc(ctx, queryContext, log)
		if err != nil {
			return nil, err
		}

		// Convert results to maps
		rows := make([]map[string]string, len(results))
		for i, result := range results {
			row, err := encoding.MarshalToMap(result)
			if err != nil {
				return nil, err
			}
			rows[i] = row
		}
		return rows, nil
	}, nil
}

// Result represents a row from the elastic_amcache_device_pnp table.
type Result struct {
	Timestamp               time.Time `osquery:"timestamp" format:"unix"`             // Last write time as Unix timestamp
	DateTime                time.Time `osquery:"date_time" format:"rfc3339" tz:"UTC"` // Last write time in RFC3339
	Model                   string    `osquery:"model"`                               // Device model
	Manufacturer            string    `osquery:"manufacturer"`                        // Manufacturer
	DriverName              string    `osquery:"driver_name"`                         // Driver name
	ParentId                string    `osquery:"parent_id"`                           // Parent device ID
	MatchingId              string    `osquery:"matching_id"`                         // Matching ID
	Class                   string    `osquery:"class"`                               // Device class
	ClassGuid               string    `osquery:"class_guid"`                          // Class GUID
	Description             string    `osquery:"description"`                         // Device description
	Enumerator              string    `osquery:"enumerator"`                          // Enumerator
	Service                 string    `osquery:"service"`                             // Service name
	InstallState            string    `osquery:"install_state"`                       // Install state
	DeviceState             string    `osquery:"device_state"`                        // Device state
	Inf                     string    `osquery:"inf"`                                 // INF path
	DriverVerDate           string    `osquery:"driver_ver_date"`                     // Driver version date
	InstallDate             string    `osquery:"install_date"`                        // Install date
	FirstInstallDate        string    `osquery:"first_install_date"`                  // First install date
	DriverPackageStrongName string    `osquery:"driver_package_strong_name"`          // Driver package strong name
	DriverVerVersion        string    `osquery:"driver_ver_version"`                  // Driver version
	ContainerId             string    `osquery:"container_id"`                        // Container ID
	ProblemCode             string    `osquery:"problem_code"`                        // Problem code
	Provider                string    `osquery:"provider"`                            // Provider
	DriverId                string    `osquery:"driver_id"`                           // Driver ID
	BusReportedDescription  string    `osquery:"bus_reported_description"`            // Bus-reported description
	HwId                    string    `osquery:"hw_id"`                               // Hardware ID
	ExtendedInfs            string    `osquery:"extended_infs"`                       // Extended INFs
	Compid                  string    `osquery:"compid"`                              // Component ID
	StackId                 string    `osquery:"stack_id"`                            // Stack ID
	UpperClassFilters       string    `osquery:"upper_class_filters"`                 // Upper class filters
	LowerClassFilters       string    `osquery:"lower_class_filters"`                 // Lower class filters
	UpperFilters            string    `osquery:"upper_filters"`                       // Upper filters
	LowerFilters            string    `osquery:"lower_filters"`                       // Lower filters
	DeviceInterfaceClasses  string    `osquery:"device_interface_classes"`            // Device interface classes
	LocationPaths           string    `osquery:"location_paths"`                      // Location paths
}

// Columns returns the column definitions for the elastic_amcache_device_pnp table.
// Windows Amcache inventory device PnP entries (Root\InventoryDevicePnp)
func Columns() []table.ColumnDefinition {
	// Generate column definitions automatically from the Result struct using reflection.
	// This ensures the columns always match the struct definition and prevents drift.
	columns, err := encoding.GenerateColumnDefinitions(Result{})
	if err != nil {
		// This should never happen in practice since we control the struct definition,
		// but if it does, panic to catch it during development/testing.
		panic("failed to generate elastic_amcache_device_pnp columns: " + err.Error())
	}
	return columns
}

// TableName is the name of the elastic_amcache_device_pnp table.
const TableName = "elastic_amcache_device_pnp"
