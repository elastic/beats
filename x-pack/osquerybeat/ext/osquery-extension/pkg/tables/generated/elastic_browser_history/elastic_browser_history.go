// Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one
// or more contributor license agreements. Licensed under the Elastic License;
// you may not use this file except in compliance with the Elastic License.

// Code generated by gentables. DO NOT EDIT.
// Source: tables/elastic_browser_history.yaml

package elasticbrowserhistory

import (
	"context"
	"errors"
	"sync"

	"time"

	"github.com/osquery/osquery-go/plugin/table"

	"github.com/elastic/beats/v7/x-pack/osquerybeat/ext/osquery-extension/pkg/encoding"
	"github.com/elastic/beats/v7/x-pack/osquerybeat/ext/osquery-extension/pkg/logger"
)

var (
	generateFunc func(context.Context, table.QueryContext, *logger.Logger) ([]Result, error)
	registerOnce sync.Once
)

// RegisterGenerateFunc registers the generate function for this table.
// This should be called once from the implementation package's init() function.
func RegisterGenerateFunc(f func(context.Context, table.QueryContext, *logger.Logger) ([]Result, error)) {
	registerOnce.Do(func() {
		generateFunc = f
	})
}

// GetGenerateFunc returns the osquery table.GenerateFunc for this table.
// It wraps the registered generate function and handles marshaling of results.
func GetGenerateFunc(log *logger.Logger) (table.GenerateFunc, error) {
	if generateFunc == nil {
		return nil, errors.New("generate function not registered for elastic_browser_history")
	}
	return func(ctx context.Context, queryContext table.QueryContext) ([]map[string]string, error) {
		results, err := generateFunc(ctx, queryContext, log)
		if err != nil {
			return nil, err
		}

		// Convert results to maps
		rows := make([]map[string]string, len(results))
		for i, result := range results {
			row, err := encoding.MarshalToMap(result)
			if err != nil {
				return nil, err
			}
			rows[i] = row
		}
		return rows, nil
	}, nil
}

// Result represents a row from the elastic_browser_history table.
type Result struct {
	Timestamp         time.Time `osquery:"timestamp" format:"unix"`            // Unix timestamp in seconds (visit time)
	Datetime          time.Time `osquery:"datetime" format:"rfc3339" tz:"UTC"` // Human-readable datetime in RFC3339 format (visit time)
	UrlId             int64     `osquery:"url_id"`                             // Unique URL identifier
	Scheme            string    `osquery:"scheme"`                             // URL scheme or protocol (https, http, file, ftp)
	Domain            string    `osquery:"domain"`                             // Registrable domain (eTLD+1) from hostname
	Hostname          string    `osquery:"hostname"`                           // Full hostname from URL
	Url               string    `osquery:"url"`                                // Full URL visited
	Title             string    `osquery:"title"`                              // Page title
	Browser           string    `osquery:"browser"`                            // Browser name (chrome, edge, firefox, safari, brave)
	Parser            string    `osquery:"parser"`                             // Parser used to extract the history
	User              string    `osquery:"user"`                               // Username or profile owner
	ProfileName       string    `osquery:"profile_name"`                       // Browser profile name
	TransitionType    string    `osquery:"transition_type"`                    // Navigation method (TYPED, LINK, BOOKMARK, RELOAD, REDIRECT, etc.)
	ReferringUrl      string    `osquery:"referring_url"`                      // URL that linked to this page when navigated via link
	VisitId           int64     `osquery:"visit_id"`                           // Unique visit identifier
	FromVisitId       int64     `osquery:"from_visit_id"`                      // Visit ID that led to this visit (navigation chain)
	VisitSource       string    `osquery:"visit_source"`                       // Data origin (browsed/local, synced, imported, extension)
	IsHidden          bool      `osquery:"is_hidden"`                          // Whether visit is hidden (1) or visible (0)
	HistoryPath       string    `osquery:"history_path"`                       // Path to the browser history database file
	ChVisitDurationMs int64     `osquery:"ch_visit_duration_ms"`               // Duration of visit in milliseconds (Chromium only)
	FfSessionId       int32     `osquery:"ff_session_id"`                      // Firefox session tracking identifier
	FfFrecency        int32     `osquery:"ff_frecency"`                        // Firefox frecency score (frequency and recency)
	SfDomainExpansion string    `osquery:"sf_domain_expansion"`                // Safari domain classification or expansion
	SfLoadSuccessful  bool      `osquery:"sf_load_successful"`                 // Whether page loaded successfully (1) or failed (0) (Safari)
	CustomDataDir     string    `osquery:"custom_data_dir"`                    // Custom data directory path for non-standard locations
}

// Columns returns the column definitions for the elastic_browser_history table.
// Browser history from multiple browsers (Chrome, Edge, Firefox, Safari) with unified schema
func Columns() []table.ColumnDefinition {
	// Generate column definitions automatically from the Result struct using reflection.
	// This ensures the columns always match the struct definition and prevents drift.
	columns, err := encoding.GenerateColumnDefinitions(Result{})
	if err != nil {
		// This should never happen in practice since we control the struct definition,
		// but if it does, panic to catch it during development/testing.
		panic("failed to generate elastic_browser_history columns: " + err.Error())
	}
	return columns
}

// TableName is the name of the elastic_browser_history table.
const TableName = "elastic_browser_history"
