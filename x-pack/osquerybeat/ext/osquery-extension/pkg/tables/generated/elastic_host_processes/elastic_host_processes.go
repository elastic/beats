// Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one
// or more contributor license agreements. Licensed under the Elastic License;
// you may not use this file except in compliance with the Elastic License.

// Code generated by gentables. DO NOT EDIT.
// Source: tables/elastic_host_processes.yaml

//go:build linux

package elastichostprocesses

import (
	"context"
	"errors"
	"sync"

	"github.com/osquery/osquery-go/plugin/table"

	"github.com/elastic/beats/v7/x-pack/osquerybeat/ext/osquery-extension/pkg/encoding"
	"github.com/elastic/beats/v7/x-pack/osquerybeat/ext/osquery-extension/pkg/logger"
)

var (
	generateFunc func(context.Context, table.QueryContext, *logger.Logger) ([]Result, error)
	registerOnce sync.Once
)

// RegisterGenerateFunc registers the generate function for this table.
// This should be called once from the implementation package's init() function.
func RegisterGenerateFunc(f func(context.Context, table.QueryContext, *logger.Logger) ([]Result, error)) {
	registerOnce.Do(func() {
		generateFunc = f
	})
}

// GetGenerateFunc returns the osquery table.GenerateFunc for this table.
// It wraps the registered generate function and handles marshaling of results.
func GetGenerateFunc(log *logger.Logger) (table.GenerateFunc, error) {
	if generateFunc == nil {
		return nil, errors.New("generate function not registered for elastic_host_processes")
	}
	return func(ctx context.Context, queryContext table.QueryContext) ([]map[string]string, error) {
		results, err := generateFunc(ctx, queryContext, log)
		if err != nil {
			return nil, err
		}

		// Convert results to maps
		rows := make([]map[string]string, len(results))
		for i, result := range results {
			row, err := encoding.MarshalToMap(result)
			if err != nil {
				return nil, err
			}
			rows[i] = row
		}
		return rows, nil
	}, nil
}

// Result represents a row from the elastic_host_processes table.
type Result struct {
	Pid              int64  `osquery:"pid"`                // Process (or thread) ID
	Name             string `osquery:"name"`               // The process path or shorthand argv[0]
	Path             string `osquery:"path"`               // Path to executed binary
	Cmdline          string `osquery:"cmdline"`            // Complete argv (command line arguments)
	State            string `osquery:"state"`              // Process state (R=running, S=sleeping, D=disk sleep, Z=zombie, T=stopped)
	Cwd              string `osquery:"cwd"`                // Process current working directory
	Root             string `osquery:"root"`               // Process virtual root directory
	Uid              int64  `osquery:"uid"`                // Unsigned user ID (real UID)
	Gid              int64  `osquery:"gid"`                // Unsigned group ID (real GID)
	Euid             int64  `osquery:"euid"`               // Unsigned effective user ID
	Egid             int64  `osquery:"egid"`               // Unsigned effective group ID
	Suid             int64  `osquery:"suid"`               // Unsigned saved user ID
	Sgid             int64  `osquery:"sgid"`               // Unsigned saved group ID
	OnDisk           int32  `osquery:"on_disk"`            // The process path exists; yes=1, no=0, unknown=-1
	WiredSize        int64  `osquery:"wired_size"`         // Bytes of unpageable memory (always 0 on Linux)
	ResidentSize     int64  `osquery:"resident_size"`      // Bytes of private memory used by process (RSS)
	TotalSize        int64  `osquery:"total_size"`         // Total virtual memory size
	UserTime         int64  `osquery:"user_time"`          // CPU time in milliseconds spent in user space
	SystemTime       int64  `osquery:"system_time"`        // CPU time in milliseconds spent in kernel space
	DiskBytesRead    int64  `osquery:"disk_bytes_read"`    // Bytes read from disk
	DiskBytesWritten int64  `osquery:"disk_bytes_written"` // Bytes written to disk
	StartTime        int64  `osquery:"start_time"`         // Process start time in seconds since Epoch, or -1 if error
	Parent           int64  `osquery:"parent"`             // Process parent's PID (PPID)
	Pgroup           int64  `osquery:"pgroup"`             // Process group ID
	Threads          int32  `osquery:"threads"`            // Number of threads used by process
	Nice             int32  `osquery:"nice"`               // Process nice level (-20 to 20, default 0)
}

// Columns returns the column definitions for the elastic_host_processes table.
// Host system running processes from /proc (e.g. when running in a container with hostfs mounted)
func Columns() []table.ColumnDefinition {
	// Generate column definitions automatically from the Result struct using reflection.
	// This ensures the columns always match the struct definition and prevents drift.
	columns, err := encoding.GenerateColumnDefinitions(Result{})
	if err != nil {
		// This should never happen in practice since we control the struct definition,
		// but if it does, panic to catch it during development/testing.
		panic("failed to generate elastic_host_processes columns: " + err.Error())
	}
	return columns
}

// TableName is the name of the elastic_host_processes table.
const TableName = "elastic_host_processes"
