// Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one
// or more contributor license agreements. Licensed under the Elastic License;
// you may not use this file except in compliance with the Elastic License.

// Code generated by beats/x-pack/osquerybeat/ext/osquery-extension/pkg/jumplists/parsers/application_id_generate.go - DO NOT EDIT.

//go:build windows

package main

import (
	"bytes"
	"fmt"
	"io"
	"net/http"
	"regexp"
	"strings"

	"github.com/elastic/beats/v7/x-pack/osquerybeat/ext/osquery-extension/pkg/logger"
)

// isHexString is a compiled regex to check for valid hex strings.
var isHexString = regexp.MustCompile(`^[0-9a-fA-F]+$`)
var isGUIDString = regexp.MustCompile(`^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$`)

// downloadPage performs a GET request with a custom User-Agent.
// It's the Go equivalent of the first part of download_webpage_as_soup.
func downloadRawPage(url string, log *logger.Logger) (string, error) {
	client := &http.Client{}
	req, err := http.NewRequest("GET", url, nil)
	if err != nil {
		return "", err
	}

	// Set the User-Agent, just like in the Python script
	req.Header.Set("User-Agent", "Mozilla/5.0")

	resp, err := client.Do(req)
	if err != nil {
		return "", err
	}
	defer resp.Body.Close()

	// Check for non-2xx status codes (like Python's raise_for_status())
	if resp.StatusCode < 200 || resp.StatusCode >= 300 {
		resp.Body.Close() // Make sure to close the body on error
		return "", fmt.Errorf("bad status: %s", resp.Status)
	}

	bodyBytes, err := io.ReadAll(resp.Body)
	if err != nil {
		return "", err
	}

	// Remove the BOM ("\uFEFF") prefix if it exists.
	// https://unicode.org/faq/utf_bom.html#bom5
	if len(bodyBytes) > 3 && bytes.Equal(bodyBytes[:3], []byte{0xef, 0xbb, 0xbf}) {
		bodyBytes = bodyBytes[3:]
	}

	return string(bodyBytes), nil
}

func writeCopyrightHeader(sb *strings.Builder) {
	sb.WriteString("// Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n")
	sb.WriteString("// or more contributor license agreements. Licensed under the Elastic License;\n")
	sb.WriteString("// you may not use this file except in compliance with the Elastic License.\n\n")
	sb.WriteString("// Code generated by beats/x-pack/osquerybeat/ext/osquery-extension/pkg/jumplists/parsers/application_id_generate.go - DO NOT EDIT.\n\n")
	sb.WriteString("//go:build windows\n\n")
	sb.WriteString("package resources\n\n")
}
