// Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one
// or more contributor license agreements. Licensed under the Elastic License;
// you may not use this file except in compliance with the Elastic License.

// Code generated by beats/x-pack/osquerybeat/ext/osquery-extension/pkg/jumplists/parsers/application_id_generate.go - DO NOT EDIT.

//go:build windows

package main

import (
	"fmt"
	"os"
	"sort"
	"strings"

	"github.com/elastic/beats/v7/x-pack/osquerybeat/ext/osquery-extension/pkg/logger"
)

const guidMappingSourceUrl = "https://github.com/EricZimmerman/GuidMapping/raw/refs/heads/master/Resources/GuidToName.txt"

// scrapeGuidMappings
func scrapeGuidMappings(log *logger.Logger) (map[string]string, error) {
	guidMappings := make(map[string]string)
	bodyString, err := downloadPage(guidMappingSourceUrl)
	if err != nil {
		return nil, err
	}

	// split the body string into lines and extract the guid and name
	// from each line, using the pipe character as the delimiter
	lines := strings.Split(bodyString, "\n")
	for _, line := range lines {
		line = strings.TrimSpace(line)
		if line == "" {
			continue // Skip empty lines
		}
		parts := strings.Split(line, "|")
		if len(parts) != 2 {
			log.Infof("invalid line in response: %s", line)
			continue
		}
		guid := strings.ToUpper(parts[0])
		guidName := parts[1]
		guidMappings[guid] = guidName
	}

	return guidMappings, nil
}

// writeGuidMappingGeneratedFile writes the guid mappings to a generated source file
// that can be used to lookup guid names by guid.
func writeGuidMappingGeneratedFile(outputFile string, log *logger.Logger) error {
	guidMappings, err := scrapeGuidMappings(log)
	if err != nil {
		return err
	}

	// Build the Go map literal string
	// Using strings.Builder is more efficient than repeated string concatenation
	var sb strings.Builder
	writeCopyrightHeader(&sb)
	sb.WriteString("// knownFolderMappings is a lookup table for known windows GUIDs to names.\n")
	sb.WriteString(fmt.Sprintf("// Source: %s\n", guidMappingSourceUrl))
	sb.WriteString("var knownFolderMappings = map[string]string{\n")

	// Sort keys for consistent output
	keys := make([]string, 0, len(guidMappings))
	for k := range guidMappings {
		keys = append(keys, k)
	}
	sort.Strings(keys)

	for _, guid := range keys {
		guidName := guidMappings[guid]
		sb.WriteString(fmt.Sprintf("\t%-40s: %q,\n", fmt.Sprintf("\"%s\"", guid), guidName))
	}
	sb.WriteString("}\n")

	err = os.WriteFile(outputFile, []byte(sb.String()), 0644)
	if err != nil {
		return err
	}

	log.Infof("Generated %s successfully", outputFile)
	return nil
}