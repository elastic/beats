// Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one
// or more contributor license agreements. Licensed under the Elastic License;
// you may not use this file except in compliance with the Elastic License.

// Code generated by gentables. DO NOT EDIT.
// Source: tables/sample_table.yaml

package samplecustomtable

import (
	"context"
	"errors"
	"sync"

	"time"

	"github.com/osquery/osquery-go/plugin/table"

	"github.com/elastic/beats/v7/x-pack/osquerybeat/ext/osquery-extension/pkg/encoding"
	"github.com/elastic/beats/v7/x-pack/osquerybeat/ext/osquery-extension/pkg/logger"
)

var (
	generateFunc func(context.Context, table.QueryContext, *logger.Logger) ([]Result, error)
	registerOnce sync.Once
)

// RegisterGenerateFunc registers the generate function for this table.
// This should be called once from the implementation package's init() function.
func RegisterGenerateFunc(f func(context.Context, table.QueryContext, *logger.Logger) ([]Result, error)) {
	registerOnce.Do(func() {
		generateFunc = f
	})
}

// GetGenerateFunc returns the osquery table.GenerateFunc for this table.
// It wraps the registered generate function and handles marshaling of results.
func GetGenerateFunc(log *logger.Logger) (table.GenerateFunc, error) {
	if generateFunc == nil {
		return nil, errors.New("generate function not registered for sample_custom_table")
	}
	return func(ctx context.Context, queryContext table.QueryContext) ([]map[string]string, error) {
		results, err := generateFunc(ctx, queryContext, log)
		if err != nil {
			return nil, err
		}

		// Convert results to maps
		rows := make([]map[string]string, len(results))
		for i, result := range results {
			row, err := encoding.MarshalToMap(result)
			if err != nil {
				return nil, err
			}
			rows[i] = row
		}
		return rows, nil
	}, nil
}

// Result represents a row from the sample_custom_table table.
type Result struct {
	Id          int64     `osquery:"id"`                                  // Unique identifier for the resource
	Name        string    `osquery:"name"`                                // Resource name or label
	Status      string    `osquery:"status"`                              // Current status (active, inactive, pending, archived)
	CreatedTime time.Time `osquery:"created_time" format:"unix" tz:"UTC"` // Creation timestamp in UNIX epoch seconds
	UpdatedTime time.Time `osquery:"updated_time" format:"unix" tz:"UTC"` // Last update timestamp in UNIX epoch seconds
	Value       float64   `osquery:"value"`                               // Associated numeric value or metric
	Enabled     int32     `osquery:"enabled"`                             // Whether the resource is enabled (1=yes, 0=no)
	Category    string    `osquery:"category"`                            // Resource category (system, user, application)
	Priority    int32     `osquery:"priority"`                            // Priority level (1=low, 2=medium, 3=high, 4=critical)
}

// Columns returns the column definitions for the sample_custom_table table.
// Example table showing the generator capabilities with multiple data types
func Columns() []table.ColumnDefinition {
	// Generate column definitions automatically from the Result struct using reflection.
	// This ensures the columns always match the struct definition and prevents drift.
	columns, err := encoding.GenerateColumnDefinitions(Result{})
	if err != nil {
		// This should never happen in practice since we control the struct definition,
		// but if it does, panic to catch it during development/testing.
		panic("failed to generate sample_custom_table columns: " + err.Error())
	}
	return columns
}

// TableName is the name of the sample_custom_table table.
const TableName = "sample_custom_table"
