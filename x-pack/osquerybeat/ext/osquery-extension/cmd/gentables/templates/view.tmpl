{{.CopyrightHeader}}{{.CodeGeneratedNotice}}{{.SourceLine}}{{.BuildTagLine}}package {{.PackageName}}

import (
	"fmt"
	"sync"
{{if .NeedsTimeImport}}
	"time"
{{end}}

	"github.com/elastic/beats/v7/x-pack/osquerybeat/ext/osquery-extension/pkg/hooks"
	"github.com/elastic/beats/v7/x-pack/osquerybeat/ext/osquery-extension/pkg/logger"
{{if .NeedsSharedImport}}
	"{{.SharedImport}}"
{{end}}
)

var (
	hooksFunc    func(*hooks.HookManager)
	registerOnce sync.Once
)

func createViewHook(socket *string, log *logger.Logger, hookData any) error {
	v, ok := hookData.(*hooks.View)
	if !ok {
		return fmt.Errorf("hook data is not a view")
	}
	return v.Create(socket, log)
}

func deleteViewHook(socket *string, log *logger.Logger, hookData any) error {
	v, ok := hookData.(*hooks.View)
	if !ok {
		return fmt.Errorf("hook data is not a view")
	}
	return v.Delete(socket, log)
}

// RegisterDefaultViewHook registers only the create/delete view hook with the hook manager.
// To add extra hooks, call RegisterHooksFunc with a function that calls RegisterDefaultViewHook(hm)
// then registers additional hooks on hm.
func RegisterDefaultViewHook(hm *hooks.HookManager) {
	hm.Register(hooks.NewHook("{{.HookName}}", createViewHook, deleteViewHook, View()))
}

// RegisterHooksFunc registers the hooks function for this view (optional).
// If called (e.g. from an implementation package), that function runs instead of the default.
// To add extra hooks while keeping the default view hook, pass a function that calls
// RegisterDefaultViewHook(hm) then registers additional hooks.
func RegisterHooksFunc(f func(*hooks.HookManager)) {
	registerOnce.Do(func() {
		hooksFunc = f
	})
}

// GetHooksFunc returns the registered hooks function for this view.
// Returns an error if no hooks function has been registered.
func GetHooksFunc() (func(*hooks.HookManager), error) {
	if hooksFunc == nil {
		return nil, fmt.Errorf("no hooks function registered for {{.Name}}")
	}
	return hooksFunc, nil
}

// Result represents a row from the {{.Name}} view.
type Result struct {
{{- range .ResultFields }}
{{- if .IsEmbedded }}
{{- if .Comment }}
	// {{.Comment}}
{{- end }}
	{{if .Pointer}}*{{end}}{{.TypeName}}
{{- else }}
	{{.Name}} {{.Type}} {{.Tag}} // {{.Description}}
{{- end }}
{{- end }}
}

// View returns the view definition for {{.Name}}.
// {{.Description}}
//
// Columns:
{{- range .ColumnsComment }}
//   - {{.}}
{{- end }}
func View() *hooks.View {
	return hooks.NewView(
		"{{.Name}}",
		{{.RequiredTables}},
		{{.ViewSQL}},
	)
}
