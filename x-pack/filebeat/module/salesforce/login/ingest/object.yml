---
description: Pipeline for parsing Salesforce Login (Object) logs.
processors:
- date:
    field: json.EventDate
    target_field: "@timestamp"
    formats:
    - ISO8601
    ignore_failure: true
- rename:
    field: json.AuthServiceId
    target_field: salesforce.login.auth.service_id
    ignore_failure: true
    ignore_missing: true
- convert:
    field: json.EvaluationTime
    type: float
    target_field: salesforce.login.evaluation_time
    ignore_failure: true
    ignore_missing: true
- rename:
    field: json.ClientVersion
    target_field: salesforce.login.client_version
    ignore_failure: true
    ignore_missing: true
- rename:
    field: cometd.channel_name
    target_field: salesforce.login.channel_name
    ignore_failure: true
    ignore_missing: true
- rename:
    field: json.LoginGeoId
    target_field: salesforce.login.geo_id
    ignore_failure: true
    ignore_missing: true
- rename:
    field: json.LoginHistoryId
    target_field: salesforce.login.history_id
    ignore_failure: true
    ignore_missing: true
- rename:
    field: json.ApiType
    target_field: salesforce.login.api.type
    ignore_failure: true
    ignore_missing: true
- rename:
    field: json.AuthMethodReference
    target_field: salesforce.login.auth.method_reference
    ignore_failure: true
    ignore_missing: true
- rename:
    field: json.LoginType
    target_field: salesforce.login.type
    ignore_failure: true
    ignore_missing: true
- rename:
    field: json.PolicyOutcome
    target_field: salesforce.login.policy_outcome
    ignore_failure: true
    ignore_missing: true
- rename:
    field: json.ApiVersion
    target_field: salesforce.login.api.version
    ignore_failure: true
    ignore_missing: true
- rename:
    field: json.EventIdentifier
    target_field: event.id
    ignore_failure: true
    ignore_missing: true
- rename:
    field: json.RelatedEventIdentifier
    target_field: salesforce.login.related_event_identifier
    ignore_failure: true
    ignore_missing: true
- rename:
    field: json.LoginKey
    target_field: salesforce.login.key
    ignore_failure: true
    ignore_missing: true
- rename:
    field: json.Application
    target_field: salesforce.login.application
    ignore_failure: true
    ignore_missing: true
- rename:
    field: json.PolicyId
    target_field: salesforce.login.policy_id
    ignore_failure: true
    ignore_missing: true
- rename:
    field: json.SessionLevel
    target_field: salesforce.login.session.level
    ignore_failure: true
    ignore_missing: true
- rename:
    field: json.SessionKey
    target_field: salesforce.login.session.key
    ignore_failure: true
    ignore_missing: true
- set:
    field: event.outcome
    value: success
    if: 'ctx?.json?.Status == "Success" && ctx?.json?.Status != null'
    ignore_failure: true
    ignore_empty_value: true
- set:
    field: event.outcome
    value: failure
    if: 'ctx?.json?.Status != "Success" && ctx?.json?.Status != null'
    ignore_failure: true
    ignore_empty_value: true
- date:
    field: json.CreatedDate
    target_field: event.created
    formats: 
    - ISO8601
    ignore_failure: true
- rename:
    field: json.LoginUrl
    target_field: event.url
    ignore_failure: true
    ignore_missing: true
- rename:
    field: json.Username
    target_field: user.email
    ignore_failure: true
    ignore_missing: true
- rename:
    field: json.UserId
    target_field: user.id
    ignore_failure: true
    ignore_missing: true
- set:
    value: ["{{{json.UserType}}}"]
    field: user.roles
    ignore_failure: true
    ignore_empty_value: true
- remove:
      field: json.UserType
      ignore_failure: true
      ignore_missing: true
- convert:
    field: json.SourceIp
    type: ip
    target_field: source.ip
    ignore_missing: true
    ignore_failure: true
- rename:
    field: json.LoginLatitude
    target_field: source.geo.location.lat
    ignore_failure: true
    ignore_missing: true
- rename:
    field: json.LoginLongitude
    target_field: source.geo.location.lon
    ignore_failure: true
    ignore_missing: true
- geoip:
    field: source.ip
    target_field: source.geo
    ignore_missing: true
    if: '!ctx.source?.geo?.location?.containsKey("lat") && !ctx.source?.geo?.location?.containsKey("lon")'
- rename:
    field: json.CountryIso
    target_field: source.geo.country_iso_code
    ignore_failure: true
    ignore_missing: true
- rename:
    field: json.PostalCode
    target_field: source.geo.postal_code
    ignore_failure: true
    ignore_missing: true
- rename:
    field: json.City
    target_field: source.geo.city_name
    ignore_failure: true
    ignore_missing: true
- rename:
    field: json.Subdivision
    target_field: source.geo.region_name
    ignore_failure: true
    ignore_missing: true
- rename:
    field: json.Country
    target_field: source.geo.country_name
    ignore_failure: true
    ignore_missing: true
- rename:
    field: json.Browser
    target_field: user_agent.name
    ignore_failure: true
    ignore_missing: true
- rename:
    field: json.Platform
    target_field: user_agent.os.platform
    ignore_failure: true
    ignore_missing: true
- rename:
    field: json.HttpMethod
    target_field: http.request.method
    ignore_failure: true
    ignore_missing: true
- rename:
    field: json.AdditionalInfo
    target_field: http.request.body.content
    ignore_failure: true
    ignore_missing: true
- rename:
    field: json.CipherSuite
    target_field: tls.cipher
    ignore_failure: true
    ignore_missing: true
- dissect:
    pattern: "%{tls.version_protocol} %{tls.version}"
    field: json.TlsProtocol
    ignore_failure: true
    ignore_missing: true

on_failure:
- set:
    field: event.kind
    value: pipeline_error
- append:
    field: error.message
    value: '{{{ _ingest.on_failure_message }}}'
