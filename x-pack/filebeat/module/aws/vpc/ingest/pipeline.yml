description: "Pipeline for s3 server access logs"

processors:
  - grok:
      field: message
      # flow log records documented in https://docs.aws.amazon.com/vpc/latest/userguide/flow-logs.html#flow-log-records
      patterns:
        - >-
          %{BASE16NUM:aws.vpc.version} %{ACCOUNTID:aws.vpc.account_id} %{INTERFACEID:aws.vpc.interface_id}
          %{IP:aws.vpc.srcaddr} %{IP:aws.vpc.dstaddr} %{NUMBER:aws.vpc.srcport}
          %{NUMBER:aws.vpc.dstport} %{NUMBER:aws.vpc.protocol} %{NUMBER:aws.vpc.packets}
          %{NUMBER:aws.vpc.bytes} %{NUMBER:aws.vpc.start} %{NUMBER:aws.vpc.end}
          %{WORD:aws.vpc.action} %{WORD:aws.vpc.log_status}

      pattern_definitions:
        ACCOUNTID: "[a-zA-Z0-9]+"
        INTERFACEID: "[a-zA-Z0-9\\/_\\.\\-%+=]+"

  #
  # Remove message fields
  #
  - remove:
      field:
        - message
      ignore_missing: true

on_failure:
  - set:
      field: "error.message"
      value: "{{ _ingest.on_failure_message }}"
