{
    "description": "Pipeline to parse s3 server access logs",
    "processors": [
        {
          "grok": {
            "field": "message",
            "patterns": [
                "%{ACCESSLOG1} %{ACCESSLOG2} %{ACCESSLOG3} %{ACCESSLOG4} %{ACCESSLOG5} %{ACCESSLOG6} %{ACCESSLOG7} %{ACCESSLOG8}"
            ],
            "pattern_definitions": {
                "ACCESSLOG1": "%{BASE16NUM:aws.s3access.bucket_owner} %{HOSTNAME:aws.s3access.bucket} \\[%{HTTPDATE:aws.s3access.time}\\]",
                "ACCESSLOG2": "%{IP:aws.s3access.remote_ip} (?:-|%{S3REQUESTER:aws.s3access.requester}) %{S3REQUESTID:aws.s3access.request_id}",
                "ACCESSLOG3": "%{S3OPERATION:aws.s3access.operation} (?:-|%{S3KEY:aws.s3access.key}) \"%{DATA:aws.s3access.request_uri}\"",
                "ACCESSLOG4": "%{NUMBER:aws.s3access.http_status:long} (?:-|%{WORD:aws.s3access.error_code}) (?:-|%{NUMBER:aws.s3access.bytes_sent:long})",
                "ACCESSLOG5": "(?:-|%{NUMBER:aws.s3access.object_size:long}) (?:-|%{NUMBER:aws.s3access.total_time:long}) (?:-|%{NUMBER:aws.s3access.turn_around_time:long})",
                "ACCESSLOG6": "(\"%{DATA:aws.s3access.referrer}\") (\"(-|%{DATA:aws.s3access.user_agent})\") (?:-|%{S3KEY:aws.s3access.version_id})",
                "ACCESSLOG7": "(?:-|%{S3ID:aws.s3access.host_id}) (?:-|%{S3VERSION:aws.s3access.signature_version}) (?:-|%{S3KEY:aws.s3access.cipher_suite})",
                "ACCESSLOG8": "(?:-|%{WORD:aws.s3access.authentication_type}) (?:-|%{S3ID:aws.s3access.host_header}) (?:-|%{S3VERSION:aws.s3access.tls_version})",
                "S3REQUESTID": "[a-zA-Z0-9]+",
                "S3OPERATION": "%{WORD}.%{WORD}.%{WORD}",
                "S3REQUESTER": "[a-zA-Z0-9\\/_\\.\\-%:@]+",
                "S3KEY": "[a-zA-Z0-9\\/_\\.\\-%]+",
                "S3ID": "[a-zA-Z0-9\\/_\\.\\-%+=]+",
                "S3VERSION": "[a-zA-Z0-9.]+"
            }
          }
        },
        {
            "date": {
                "field": "aws.s3access.time",
                "target_field": "@timestamp",
                "formats": [
                    "dd/MMM/yyyy:H:m:s Z"
                ],
                "ignore_failure": true
            }
        },
        {
            "remove": {
                "field": "aws.s3access.time",
                "ignore_failure": true
            }
        },
        {
            "remove": {
                "field": "message"
            }
        }
    ],
    "on_failure": [
        {
            "set": {
                "field": "error.message",
                "value": "{{ _ingest.on_failure_message }}"
            }
        }
    ]
}
