description: "Pipeline for s3 server access logs"

processors:
  - grok:
      field: message
      patterns:
        - >-
          %{TIMESTAMP_ISO8601:_tmp.timestamp} %{MONTH:_tmp.month} %{MONTHDAY:_tmp.day} %{TIME:_tmp.time} %{IPORHOST:aws.cloudwatch.ip} %{NOTSPACE:aws.cloudwatch.program_name}: %{GREEDYDATA:message}
        - >-
          %{TIMESTAMP_ISO8601:_tmp.timestamp} %{GREEDYDATA:message}

  - date:
      field: "_tmp_.timestamp"
      target_field: "@timestamp"
      ignore_failure: true
      formats:
        - "dd/MMM/yyyy:H:m:s Z"
  - remove:
      field:
        - _tmp
      ignore_missing: true

on_failure:
  - set:
      field: "error.message"
      value: "{{ _ingest.on_failure_message }}"
