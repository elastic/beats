description: Pipeline for parsing cloudflare http logs
processors:
- date:
    field: cloudflare.log.Timestamp
    formats:
    - uuuu-MM-dd'T'HH:mm:ssX
    - uuuu-MM-dd'T'HH:mm:ss.SSSX
    - yyyy-MM-dd'T'HH:mm:ssZ
    - yyyy-MM-dd'T'HH:mm:ss.SSSZ
    timezone: UTC
    target_field: "@timestamp"
- date:
    field: cloudflare.log.EdgeStartTimestamp
    formats:
    - uuuu-MM-dd'T'HH:mm:ssX
    - uuuu-MM-dd'T'HH:mm:ss.SSSX
    - yyyy-MM-dd'T'HH:mm:ssZ
    - yyyy-MM-dd'T'HH:mm:ss.SSSZ
    timezone: UTC
    target_field: "event.start"
- date:
    field: cloudflare.log.EdgeEndTimestamp
    formats:
    - uuuu-MM-dd'T'HH:mm:ssX
    - uuuu-MM-dd'T'HH:mm:ss.SSSX
    - yyyy-MM-dd'T'HH:mm:ssZ
    - yyyy-MM-dd'T'HH:mm:ss.SSSZ
    timezone: UTC
    target_field: "event.end"
- convert:
    field: cloudflare.log.ClientIP
    target_field: source.ip
    type: ip
- set:
    field: source.address
    value: "{{source.ip}}"
- geoip:
    field: source.ip
    target_field: source.geo
    ignore_missing: true
    if: "ctx.source?.geo == null"
- rename:
    field: cloudflare.log.ClientCountry
    target_field: source.geo.country_iso_code
    ignore_missing: true
    if: ctx?.source?.geo?.country_iso_code == null || ctx?.source?.geo?.country_iso_code != cloudflare.log.ClientCountry
- geoip:
    database_file: GeoLite2-ASN.mmdb
    field: source.ip
    target_field: source.as
    properties:
    - asn
    - organization_name
    ignore_missing: true
- rename:
    field: source.as.asn
    target_field: source.as.number
    ignore_missing: true
- rename:
    field: cloudflare.log.ClientASN
    target_field: source.as.number
    ignore_missing: true
    if: ctx?.source?.as?.number == null || ctx?.source?.as?.number != cloudflare.log.ClientASN
- rename:
    field: source.as.organization_name
    target_field: source.as.organization.name
    ignore_missing: true
- dissect:
    field: cloudflare.log.ClientRequestProtocol
    pattern: HTTP/%{http.version}
- rename:
    field: CacheCacheStatus
    target_field: cloudflare.log.cache.status
    ignore_missing: true

- rename:
    field: CacheTieredFill
    target_field: cloudflare.log.cache.status
    ignore_missing: true
- rename:
    field: cloudflare.log.ClientDeviceType
    target_field: cloudflare.device.type
    ignore_missing: true
- rename:
    field: cloudflare.log.ClientIPClass
    target_field: cloudflare.client.ip.class
    ignore_missing: true
- convert:
    field: cloudflare.log.ClientRequestBytes
    target_field: source.bytes
    type: long
    ignore_missing: true
- convert:
    field: cloudflare.log.EdgeResponseBytes
    target_field: destination.bytes
    type: long
    ignore_missing: true
- script:
    lang: painless
    source: "ctx.network.bytes = ctx.source.bytes + ctx.destination.bytes"
    if: "ctx?.source?.bytes != null && ctx?.destination?.bytes != null"
    ignore_failure: true
- convert:
    field: cloudflare.log.EdgeResponseBodyBytes
    target_field: http.response.body.bytes
    type: long
    ignore_missing: true
- rename:
    field: cloudflare.log.ClientRequestMethod
    target_field: http.request.method
    ignore_missing: true
- rename:
    field: cloudflare.log.ClientRequestReferer
    target_field: http.request.referrer
    ignore_missing: true
- rename:
    field: cloudflare.log.ClientRequestURI
    target_field: url.full
    ignore_missing: true
- uri_parts:
    field: url.full
    ignore_failure: true
    if: ctx?.url?.full != null
- rename:
    field: cloudflare.log.ClientRequestHost
    target_field: url.domain
    ignore_missing: true
    if: ctx?.url?.domain == null
- rename:
    field: cloudflare.log.ClientRequestPath
    target_field: url.path
    ignore_missing: true
    if: ctx?.url?.path == null
- user_agent:
    field: cloudflare.log.ClientRequestUserAgent
    target_field: user_agent
    ignore_missing: true
- rename:
    field: cloudflare.log.ClientSSLCipher
    target_field: tls.cipher
    ignore_missing: true
- rename:
    field: cloudflare.log.ClientSSLProtocol
    target_field: tls.version_protocol
    ignore_missing: true
- rename:
    field: cloudflare.log.ClientSrcPort
    target_field: source.port
    ignore_missing: true
- rename:
    field: EdgeColoCode
    target_field: cloudflare.edge.colo.code
    ignore_missing: true
- rename:
    field: EdgeColoID
    target_field: cloudflare.edge.colo.id
    ignore_missing: true
- rename:
    field: EdgePathingOp
    target_field: cloudflare.edge.pathing.op
    ignore_missing: true
- rename:
    field: EdgePathingSrc
    target_field: cloudflare.edge.pathing.src
    ignore_missing: true
- rename:
    field: EdgePathingStatus
    target_field: cloudflare.edge.pathing.status
    ignore_missing: true
- rename:
    field: EdgeRateLimitAction
    target_field: cloudflare.edge.rate.limit.action
    ignore_missing: true
- rename:
    field: EdgeRateLimitID
    target_field: cloudflare.edge.rate.limit.id
    ignore_missing: true
- rename:
    field: EdgeRequestHost
    target_field: cloudflare.edge.request.host
    ignore_missing: true
- rename:
    field: EdgeResponseCompressionRatio
    target_field: cloudflare.edge.response.compression_ratio
    ignore_missing: true
- rename:
    field: EdgeResponseContentType
    target_field: cloudflare.edge.response.content_type
    ignore_missing: true
- rename:
    field: EdgeResponseStatus
    target_field: http.response.status_code
    ignore_missing: true
- convert:
    field: clouflare.log.EdgeServerIP
    target_field: observer.ip
    type: long
    ignore_missing: true
- rename:
    field: cloudflare.log.FirewallMatchesActions
    target_field: event.action
    ignore_missing: true
- rename:
    field: FirewallMatchesSources
    target_field: cloudflare.firewall.matches.sources
    ignore_missing: true
- rename:
    field: cloudflare.log.FirewallMatchesRuleIDs
    target_field: rule.id
    ignore_missing: true
- convert:
    field: cloudflare.log.OriginIP
    target_field: destination.ip
    type: ip
    ignore_missing: true
- convert:
    field: cloudflare.log.OriginResponseTime
    type: long
    ignore_missing: true
- rename:
    field: cloudflare.log.WAFAction
    target_field: event.action
    ignore_missing: true
- rename:
    field: cloudflare.log.WAFRuleID
    target_field: rule.id
    ignore_missing: true
- rename:
    field: cloudflare.log.WAFRuleMessage
    target_field: rule.description
    ignore_missing: true
- rename:
    field: WorkerCPUTime
    type: long
    ignore_missing: true


- remove:
    field:
      - cloudflare.log.EdgeStartTimestamp
      - cloudflare.log.CacheResponseBytes
      - cloudflare.log.CacheResponseStatus
      - cloudflare.log.ClientCountry
      - cloudflare.log.ClientASN
      - cloudflare.log.ClientRequestBytes
      - cloudflare.log.ClientRequestUserAgent
      - cloudflare.log.EdgeResponseBytes
      - cloudflare.log.EdgeServerIP
      - cloudflare.log.OriginIP
      - cloudflare.log.WAFFlags
      - cloudflare.log.WAFMatchedVar
      - cloudflare.log.
      - cloudflare.log.
      - cloudflare.log.



      - cloudflare.log.

    ignore_missing: true



on_failure:
- set:
    field: error.message
    value: "{{ _ingest.on_failure_message }}"
