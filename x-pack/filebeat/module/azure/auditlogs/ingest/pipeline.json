{
  "description": "Pipeline for parsing azure activity logs.",
  "processors": [
      {
          "json" : {
              "field" : "message",
              "target_field" : "azure.auditlogs"
          }
      },
      {
          "drop": {
              "if" : "ctx.azure.auditlogs.category != 'AuditLogs'"
          }
      },
      {
          "date": {
              "field": "azure.auditlogs.time",
              "target_field": "@timestamp",
              "ignore_failure": true,
              "formats": [
                  "ISO8601"
              ]
          }
      },
      {
          "rename": {
              "field": "azure.auditlogs.resourceId",
              "target_field": "azure.resource_id",
              "ignore_missing": true
          }
      },
      {
          "rename": {
              "field": "azure.auditlogs.durationMs",
              "target_field": "event.duration",
              "ignore_missing": true
          }
      },
      {
          "script": {
              "lang": "painless",
              "source": "ctx.event.duration = ctx.event.duration * params.param_nano",
              "params": {
                  "param_nano": 1000000
              }
          }
      },
      {
          "rename": {
              "field": "azure.auditlogs.properties.result",
              "target_field": "event.outcome",
              "ignore_missing": true
          }
      },
      {
          "rename": {
              "field": "azure.auditlogs.level",
              "target_field": "log.level",
              "ignore_missing": true
          }
      },
      {
          "remove": {
              "field": ["message", "azure.auditlogs.time"],
              "ignore_missing": true
          }
      },
      {
          "rename": {
              "field": "azure.auditlogs.category",
              "target_field": "event.category",
              "ignore_missing": true
          }
      },
      {
          "rename": {
              "field": "azure.auditlogs.operationName",
              "target_field": "azure.auditlogs.operation_name",
              "ignore_missing": true
          }
      },
      {
          "rename": {
              "field": "azure.auditlogs.resultSignature",
              "target_field": "azure.auditlogs.result_signature",
              "ignore_missing": true
          }
      },
      {
          "rename": {
              "field": "azure.auditlogs.operationVersion",
              "target_field": "azure.auditlogs.operation_version",
              "ignore_missing": true
          }
      },
      {
          "rename": {
              "field": "azure.auditlogs.tenantId",
              "target_field": "azure.tenant_id",
              "ignore_missing": true
          }
      },
      {
          "rename": {
              "field": "azure.auditlogs.correlationId",
              "target_field": "azure.correlation_id",
              "ignore_missing": true
          }
      },
      {
          "rename": {
              "field": "azure.auditlogs.properties.activityDisplayName",
              "target_field": "azure.auditlogs.properties.activity_display_name",
              "ignore_missing": true
          }
      },
      {
          "rename": {
              "field": "azure.auditlogs.properties.activityDateTime",
              "target_field": "azure.auditlogs.properties.activity_datetime",
              "ignore_missing": true
          }
      },
      {
          "rename": {
              "field": "azure.auditlogs.properties.additionalDetails",
              "target_field": "azure.auditlogs.properties.additional_details",
              "ignore_missing": true
          }
      },
      {
          "rename": {
              "field": "azure.auditlogs.properties.resultReason",
              "target_field": "azure.auditlogs.properties.result_reason",
              "ignore_missing": true
          }
      },
      {
          "rename": {
              "field": "azure.auditlogs.properties.correlationId",
              "target_field": "azure.auditlogs.properties.correlation_id",
              "ignore_missing": true
          }
      },
      {
          "rename": {
              "field": "azure.auditlogs.properties.loggedByService",
              "target_field": "azure.auditlogs.properties.logged_by_service",
              "ignore_missing": true
          }
      },
      {
          "rename": {
              "field": "azure.auditlogs.properties.operationType",
              "target_field": "azure.auditlogs.properties.operation_type",
              "ignore_missing": true
          }
      },
      {
          "rename": {
              "field": "azure.auditlogs.properties.targetResources",
              "target_field": "azure.auditlogs.properties.target_resources",
              "ignore_missing": true
          }
      },
      {
          "foreach": {
              "field": "azure.auditlogs.properties.target_resources",
              "processor": {
                  "rename": {
                      "field": "_ingest._value.displayName",
                      "target_field": "_ingest._value.display_name",
                      "ignore_missing": true
                  }
              }
          }
      },
      {
          "foreach": {
              "field": "azure.auditlogs.properties.target_resources",
              "processor": {
                  "rename": {
                      "field": "_ingest._value.ipAddress",
                      "target_field": "_ingest._value.ip_address",
                      "ignore_missing": true
                  }
              }
          }
      },
      {
          "foreach": {
              "field": "azure.auditlogs.properties.target_resources",
              "processor": {
                  "rename": {
                      "field": "_ingest._value.userPrincipalName",
                      "target_field": "_ingest._value.user_principal_name",
                      "ignore_missing": true
                  }
              }
          }
      },
      {
          "foreach": {
              "field": "azure.auditlogs.properties.target_resources",
              "processor": {
                  "rename": {
                      "field": "_ingest._value.modifiedProperties",
                      "target_field": "_ingest._value.modified_properties",
                      "ignore_missing": true
                  }
              }
          }
      },
      {
          "foreach": {
              "field": "azure.auditlogs.properties.target_resources",
              "processor": {
                  "foreach": {
                      "field": "_ingest._value.modified_properties",
                      "processor": {
                          "rename": {
                              "field": "_ingest._value.displayName",
                              "target_field": "_ingest._value.display_name",
                              "ignore_missing": true
                          }
                      }
                  }
              }
          }
      },
      {
          "foreach": {
              "field": "azure.auditlogs.properties.target_resources",
              "processor": {
                  "foreach": {
                      "field": "_ingest._value.modified_properties",
                      "processor": {
                          "rename": {
                              "field": "_ingest._value.oldValue",
                              "target_field": "_ingest._value.old_value",
                              "ignore_missing": true
                          }
                      }
                  }
              }
          }
      },
      {
          "foreach": {
              "field": "azure.auditlogs.properties.target_resources",
              "processor": {
                  "foreach": {
                      "field": "_ingest._value.modified_properties",
                      "processor": {
                          "rename": {
                              "field": "_ingest._value.newValue",
                              "target_field": "_ingest._value.new_value",
                              "ignore_missing": true
                          }
                      }
                  }
              }
          }
      },
      {
          "rename": {
              "field": "azure.auditlogs.properties.initiatedBy",
              "target_field": "azure.auditlogs.properties.initiated_by",
              "ignore_missing": true
          }
      },
      {
          "pipeline": {
              "name": "{< IngestPipeline "azure-shared-pipeline" >}"
          }
      }
  ],
  "on_failure": [
  {
    "set": {
      "field": "error.message",
      "value": "{{ _ingest.on_failure_message }}"
    }
  }
  ]
}
