{
  "description": "Pipeline for parsing fortinet firewall logs (traffic pipeline)",
  "processors": [
    {
      "set": {
        "field": "server.ip",
        "value": "{{fortinet.firewall.dstip}}",
        "if": "ctx.fortinet?.firewall?.dstip != null"
      }
    },
    {
      "set": {
        "field": "destination.ip",
        "value": "{{fortinet.firewall.dstip}}",
        "if": "ctx.fortinet?.firewall?.dstip != null"
      }
    },
    {
      "set": {
        "field": "server.nat.ip",
        "value": "{{fortinet.firewall.tranip}}",
        "if": "ctx.fortinet?.firewall?.tranip != null"
      }
    },
    {
      "set": {
        "field": "destination.nat.ip",
        "value": "{{fortinet.firewall.tranip}}",
        "if": "ctx.fortinet?.firewall?.tranip != null"
      }
    },
    {
      "set": {
        "field": "server.port",
        "value": "{{fortinet.firewall.dstport}}",
        "if": "ctx.fortinet?.firewall?.dstport != null"
      }
    },
    {
      "set": {
        "field": "destination.port",
        "value": "{{fortinet.firewall.dstport}}",
        "if": "ctx.fortinet?.firewall?.dstport != null"
      }
    },
    {
      "set": {
        "field": "server.nat.port",
        "value": "{{fortinet.firewall.tranport}}",
        "if": "ctx.fortinet?.firewall?.tranport != null"
      }
    },
    {
      "set": {
        "field": "destination.nat.port",
        "value": "{{fortinet.firewall.tranport}}",
        "if": "ctx.fortinet?.firewall?.tranport != null"
      }
    },
    {
      "set": {
        "field": "server.bytes",
        "value": "{{fortinet.firewall.rcvdbyte}}",
        "if": "ctx.fortinet?.firewall?.rcvdbyte != null"
      }
    },
    {
      "set": {
        "field": "destination.bytes",
        "value": "{{fortinet.firewall.rcvdbyte}}",
        "if": "ctx.fortinet?.firewall?.rcvdbyte != null"
      }
    },
    {
      "set": {
        "field": "server.packets",
        "value": "{{fortinet.firewall.rcvdpkt}}",
        "if": "ctx.fortinet?.firewall?.rcvdpkt != null"
      }
    },
    {
      "set": {
        "field": "destination.packets",
        "value": "{{fortinet.firewall.rcvdpkt}}",
        "if": "ctx.fortinet?.firewall?.rcvdpkt != null"
      }
    },
    {
      "set": {
        "field": "server.user.email",
        "value": "{{fortinet.firewall.dstcollectedemail}}",
        "if": "ctx.fortinet?.firewall?.dstcollectedemail != null"
      }
    },
    {
      "set": {
        "field": "destination.user.email",
        "value": "{{fortinet.firewall.dstcollectedemail}}",
        "if": "ctx.fortinet?.firewall?.dstcollectedemail != null"
      }
    },
    {
      "set": {
        "field": "destination.address",
        "value": "{{fortinet.firewall.dstname}}",
        "if": "ctx.fortinet?.firewall?.dstname != null"
      }
    },
    {
      "set": {
        "field": "server.address",
        "value": "{{fortinet.firewall.dstname}}",
        "if": "ctx.fortinet?.firewall?.dstname != null"
      }
    },
    {
      "set": {
        "field": "destination.user.name",
        "value": "{{fortinet.firewall.dstunauthuser}}",
        "if": "ctx.fortinet?.firewall?.dstunauthuser != null"
      }
    },
    {
      "set": {
        "field": "server.address",
        "value": "{{fortinet.firewall.dstunauthuser}}",
        "if": "ctx.fortinet?.firewall?.dstunauthuser != null"
      }
    },
    {
      "set": {
        "field": "source.user.group.name",
        "value": "{{fortinet.firewall.group}}",
        "if": "ctx.fortinet?.firewall?.group != null"
      }
    },
    {
      "set": {
        "field": "client.user.group.name",
        "value": "{{fortinet.firewall.group}}",
        "if": "ctx.fortinet?.firewall?.group != null"
      }
    },
    {
      "set": {
        "field": "source.bytes",
        "value": "{{fortinet.firewall.sentbyte}}",
        "if": "ctx.fortinet?.firewall?.sentbyte != null"
      }
    },
    {
      "set": {
        "field": "client.bytes",
        "value": "{{fortinet.firewall.sentbyte}}",
        "if": "ctx.fortinet?.firewall?.sentbyte != null"
      }
    },
    {
      "set": {
        "field": "source.domain",
        "value": "{{fortinet.firewall.srcdomain}}",
        "if": "ctx.fortinet?.firewall?.srcdomain != null"
      }
    },
    {
      "set": {
        "field": "client.domain",
        "value": "{{fortinet.firewall.srcdomain}}",
        "if": "ctx.fortinet?.firewall?.srcdomain != null"
      }
    },
    {
      "set": {
        "field": "source.ip",
        "value": "{{fortinet.firewall.srcip}}",
        "if": "ctx.fortinet?.firewall?.srcip != null && ctx.source?.ip == null"
      }
    },
    {
      "set": {
        "field": "client.ip",
        "value": "{{fortinet.firewall.srcip}}",
        "if": "ctx.fortinet?.firewall?.srcip != null && ctx.client?.ip == null"
      }
    },
    {
      "set": {
        "field": "source.mac",
        "value": "{{fortinet.firewall.srcmac}}",
        "if": "ctx.fortinet?.firewall?.srcmac != null"
      }
    },
    {
      "set": {
        "field": "client.mac",
        "value": "{{fortinet.firewall.srcmac}}",
        "if": "ctx.fortinet?.firewall?.srcmac != null"
      }
    },
    {
      "set": {
        "field": "source.port",
        "value": "{{fortinet.firewall.srcport}}",
        "if": "ctx.fortinet?.firewall?.srcport != null && ctx.source?.port == null"
      }
    },
    {
      "set": {
        "field": "client.port",
        "value": "{{fortinet.firewall.srcport}}",
        "if": "ctx.fortinet?.firewall?.srcport != null && ctx.client?.port == null"
      }
    },
    {
      "set": {
        "field": "source.user.name",
        "value": "{{fortinet.firewall.unauthuser}}",
        "if": "ctx.fortinet?.firewall?.unauthuser != null"
      }
    },
    {
      "set": {
        "field": "source.user.name",
        "value": "{{fortinet.firewall.user}}",
        "if": "ctx.fortinet?.firewall?.user != null && ctx.source?.user?.name == null"
      }
    },
    {
      "set": {
        "field": "client.user.name",
        "value": "{{fortinet.firewall.unauthuser}}",
        "if": "ctx.fortinet?.firewall?.unauthuser != null"
      }
    },
    {
      "set": {
        "field": "client.user.name",
        "value": "{{fortinet.firewall.user}}",
        "if": "ctx.fortinet?.firewall?.user != null && ctx.client?.user?.name == null"
      }
    },
    {
      "set": {
        "field": "source.user.email",
        "value": "{{fortinet.firewall.collectedemail}}",
        "if": "ctx.fortinet?.firewall?.collectedemail != null"
      }
    },
    {
      "set": {
        "field": "client.user.email",
        "value": "{{fortinet.firewall.collectedemail}}",
        "if": "ctx.fortinet?.firewall?.collectemail != null"
      }
    },
    {
      "set": {
        "field": "source.packets",
        "value": "{{fortinet.firewall.sentpkt}}",
        "if": "ctx.fortinet?.firewall?.sentpkt != null"
      }
    },
    {
      "set": {
        "field": "client.packets",
        "value": "{{fortinet.firewall.sentpkt}}",
        "if": "ctx.fortinet?.firewall?.sentpkt != null"
      }
    },
    {
      "set": {
        "field": "source.nat.ip",
        "value": "{{fortinet.firewall.transip}}",
        "if": "ctx.fortinet?.firewall?.transip != null"
      }
    },
    {
      "set": {
        "field": "client.nat.ip",
        "value": "{{fortinet.firewall.transip}}",
        "if": "ctx.fortinet?.firewall?.transip != null"
      }
    },
    {
      "set": {
        "field": "source.nat.port",
        "value": "{{fortinet.firewall.transport}}",
        "if": "ctx.fortinet?.firewall?.transport != null"
      }
    },
    {
      "set": {
        "field": "client.nat.port",
        "value": "{{fortinet.firewall.transport}}",
        "if": "ctx.fortinet?.firewall?.transport != null"
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.app",
        "target_field": "network.application",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.comment",
        "target_field": "rule.description",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.devid",
        "target_field": "observer.serial_number",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.dstintf",
        "target_field": "observer.egress.interface.name",
        "ignore_missing": true,
        "if": "ctx.observer?.egress?.interface?.name == null"
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.filename",
        "target_field": "file.name",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.level",
        "target_field": "log.level",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.logid",
        "target_field": "event.code",
        "ignore_missing": true,
        "if": "ctx.event?.code == null"
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.msg",
        "target_field": "message",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.policyid",
        "target_field": "rule.id",
        "ignore_missing": true,
        "if": "ctx.rule?.id == null"
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.proto",
        "target_field": "network.iana_number",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.service",
        "target_field": "network.protocol",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.poluuid",
        "target_field": "rule.uuid",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.srcintf",
        "target_field": "observer.ingress.interface.name",
        "ignore_missing": true,
        "if": "ctx.observer?.ingress?.interface?.name == null"
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.url",
        "target_field": "url.path",
        "ignore_missing": true
      }
    },
    {
      "remove": {
        "field": [
          "fortinet.firewall.locip",
          "fortinet.firewall.locport",
          "fortinet.firewall.srcip",
          "fortinet.firewall.src_ip",
          "fortinet.firewall.src_port",
          "fortinet.firewall.srcport",
          "fortinet.firewall.srcdomain",
          "fortinet.firewall.srcmac",
          "fortinet.firewall.unauthuser",
          "fortinet.firewall.user",
          "fortinet.firewall.sentbyte",
          "fortinet.firewall.rcvdbyte",
          "fortinet.firewall.remip",
          "fortinet.firewall.remport",
          "fortinet.firewall.dstport",
          "fortinet.firewall.dst_port",
          "fortinet.firewall.dstip",
          "fortinet.firewall.recipient"
        ],
        "ignore_missing": true
      }
    }
  ],
  "on_failure": [
    {
      "set": {
        "field": "error.message",
        "value": "{{ _ingest.on_failure_message }}"
      }
    }
  ]
}