{
  "description": "Pipeline for parsing fortinet firewall logs (traffic pipeline)",
  "processors": [
    {
      "set": {
        "field": "event.kind",
        "value": "event"
      }
    },
    {
      "set": {
        "field": "event.action",
        "value": "{{fortinet.firewall.action}}",
        "if": "ctx.fortinet?.firewall?.action != null"
      }
    },
    {
      "set": {
        "field": "event.outcome",
        "value": "success",
        "if": "ctx.fortinet?.firewall?.action != null"
      }
    },
    {
      "append": {
        "field": "event.category",
        "value": "network"
      }
    },
    {
      "append": {
        "field": "event.type",
        "value": "connection"
      }
    },
    {
      "append": {
        "field": "event.type",
        "value": "start",
        "if": "ctx.fortinet?.firewall?.action == 'start'"
      }
    },
    {
      "append": {
        "field": "event.type",
        "value": "end",
        "if": "ctx.fortinet?.firewall?.action != 'start' && ctx.fortinet?.firewall?.action != null"
      }
    },
    {
      "append": {
        "field": "event.type",
        "value": "error",
        "if": "['dns', 'ip-conn'].contains(ctx.fortinet?.firewall?.action)"
      }
    },
    {
      "append": {
        "field": "event.type",
        "value": "network",
        "if": "ctx.fortinet?.firewall?.app != null && ctx.fortinet?.firewall?.action != 'deny'"
      }
    },
    {
      "append": {
        "field": "event.type",
        "value": "allowed",
        "if": "ctx.fortinet?.firewall?.utmaction == null && ctx.fortinet?.firewall?.action != 'deny'"
      }
    },
    {
      "append": {
        "field": "event.type",
        "value": "denied",
        "if": "ctx.fortinet?.firewall?.utmaction == 'block'"
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.dstip",
        "target_field": "destination.ip",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.tranip",
        "target_field": "destination.nat.ip",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.dstport",
        "target_field": "destination.port",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.tranport",
        "target_field": "destination.nat.port",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.rcvdbyte",
        "target_field": "destination.bytes",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.rcvdpkt",
        "target_field": "destination.packets",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.dstcollectedemail",
        "target_field": "destination.user.email",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.dstname",
        "target_field": "destination.address",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.dstunauthuser",
        "target_field": "destination.user.name",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.group",
        "target_field": "source.user.group.name",
        "ignore_missing": true,
        "if": "ctx.fortinet?.firewall?.group != 'N/A'"
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.sentbyte",
        "target_field": "source.bytes",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.srcdomain",
        "target_field": "source.domain",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.srcip",
        "target_field": "source.ip",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.srcmac",
        "target_field": "source.mac",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.srcport",
        "target_field": "source.port",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.unauthuser",
        "target_field": "source.user.name",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.user",
        "target_field": "source.user.name",
        "ignore_missing": true,
        "if": "ctx.source?.user?.name == null"
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.collectedemail",
        "target_field": "source.user.email",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.sentpkt",
        "target_field": "source.packets",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.transip",
        "target_field": "source.nat.ip",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.transport",
        "target_field": "source.nat.port",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.app",
        "target_field": "network.application",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.filename",
        "target_field": "file.name",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.logid",
        "target_field": "event.code",
        "ignore_missing": true,
        "if": "ctx.event?.code == null"
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.msg",
        "target_field": "message",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.comment",
        "target_field": "rule.description",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.policyid",
        "target_field": "rule.id",
        "ignore_missing": true,
        "if": "ctx.rule?.id == null"
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.poluuid",
        "target_field": "rule.uuid",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.policytype",
        "target_field": "rule.ruleset",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.policyname",
        "target_field": "rule.name",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.appcat",
        "target_field": "rule.category",
        "ignore_missing": true
      }
    },
    {
      "gsub": {
        "field": "rule.category",
        "pattern": "\\.",
        "replacement": "-",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.proto",
        "target_field": "network.iana_number",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.service",
        "target_field": "network.protocol",
        "ignore_missing": true
      }
    },
    {
      "lowercase": {
        "field": "network.protocol",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.url",
        "target_field": "url.path",
        "ignore_missing": true
      }
    },
    {
      "geoip" : {
        "field": "source.ip",
        "target_field": "source.geo",
        "ignore_missing": true,
        "if": "ctx.source?.geo == null"
      }
    },
    {
      "geoip" : {
        "field": "destination.ip",
        "target_field": "destination.geo",
        "ignore_missing": true,
        "if": "ctx.destination?.geo == null"
      }
    },
    {
      "geoip" : {
        "database_file": "GeoLite2-ASN.mmdb",
        "field": "source.ip",
        "target_field": "source.as",
        "properties": ["asn", "organization_name"],
        "ignore_missing": true
      }
    },
    {
      "geoip" : {
        "database_file": "GeoLite2-ASN.mmdb",
        "field": "destination.ip",
        "target_field": "destination.as",
        "properties": ["asn", "organization_name"],
        "ignore_missing": true
      }
    },
    {
      "rename" : {
        "field": "source.as.asn",
        "target_field": "source.as.number",
        "ignore_missing": true
      }
    },
    {
      "rename" : {
        "field": "source.as.organization_name",
        "target_field": "source.as.organization.name",
        "ignore_missing": true
      }
    },
    {
      "rename" : {
        "field": "destination.as.asn",
        "target_field": "destination.as.number",
        "ignore_missing": true
      }
    },
    {
      "rename" : {
        "field": "destination.as.organization_name",
        "target_field": "destination.as.organization.name",
        "ignore_missing": true
      }
    },
    {
      "remove": {
        "field": [
          "fortinet.firewall.dstip",
          "fortinet.firewall.tranip",
          "fortinet.firewall.dstport",
          "fortinet.firewall.tranport",
          "fortinet.firewall.rcvdbyte",
          "fortinet.firewall.rcvdpkt",
          "fortinet.firewall.dstname",
          "fortinet.firewall.dstcollectedemail",
          "fortinet.firewall.dstunauthuser",
          "fortinet.firewall.group",
          "fortinet.firewall.sentbyte",
          "fortinet.firewall.srcdomain",
          "fortinet.firewall.srcip",
          "fortinet.firewall.srcport",
          "fortinet.firewall.unauthuser",
          "fortinet.firewall.user",
          "fortinet.firewall.collectedemail",
          "fortinet.firewall.sentpkt",
          "fortinet.firewall.transip",
          "fortinet.firewall.transport"
        ],
        "ignore_missing": true
      }
    }
  ],
  "on_failure": [
    {
      "set": {
        "field": "error.message",
        "value": "{{ _ingest.on_failure_message }}"
      }
    }
  ]
}