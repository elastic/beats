{ 
"description": "Pipeline for parsing fortinet firewall logs",
  "processors": [
    {
        "grok": {
          "field": "message",
          "patterns": [
            "%{SYSLOG5424PRI}%{GREEDYDATA:syslog5424_sd}$"
          ]
        }
      },
      {
        "kv": {
          "field": "syslog5424_sd",
          "field_split": " (?=[a-z]+=)",
          "value_split": "=",
          "prefix": "fortinet.firewall.",
          "ignore_missing": true,
          "ignore_failure": false,
          "trim_value": "\""
        }
      },
      {
        "set": {
          "field": "observer.vendor",
          "value": "Fortinet"
        }
      },
      {
        "set": {
          "field": "observer.product",
          "value": "Fortigate"
        }
      },
      {
        "set": {
          "field": "observer.type",
          "value": "firewall"
        }
      },
      {
        "set": {
          "field": "event.module",
          "value": "fortinet"
        }
      },
      {
        "set": {
          "field": "event.timezone",
          "value": "{{fortinet.firewall.tz}}"
        }
      },
      {
        "set": {
          "field": "_temp.time",
          "value": "{{fortinet.firewall.date}} {{fortinet.firewall.time}} {{fortinet.firewall.tz}}",
          "if": "ctx.fortinet?.firewall?.tz != null"
        }
      },
      {
        "set": {
          "field": "_temp.time",
          "value": "{{fortinet.firewall.date}} {{fortinet.firewall.time}}Z",
          "if": "ctx.fortinet?.firewall?.tz == null"
        }
      },
      {
        "date": {
          "field": "_temp.time",
          "target_field": "@timestamp", 
          "formats": ["yyyy-MM-dd HH:mm:ss", "yyyy-MM-dd HH:mm:ss Z", "ISO8601"],
          "timezone": "{{fortinet.firewall.tz}}"
        }
      },
      {
        "gsub": {
          "field": "fortinet.firewall.eventtime",
          "pattern": "\\d{6}$",
          "replacement": ""
        }
      },
      {
        "date": {
          "field": "fortinet.firewall.eventtime",
          "target_field": "event.start", 
          "formats": ["UNIX_MS"],
          "timezone": "{{fortinet.firewall.tz}}"
        }
      },
      {
        "remove": {
          "field": [
            "_temp",
            "message",
            "syslog5424_sd",
            "syslog5424_pri",
            "fortinet.firewall.tz",
            "fortinet.firewall.date",
            "fortinet.firewall.eventtime",
            "fortinet.firewall.time"
          ],
          "ignore_missing": true
        }
      },
      {
        "pipeline": {
          "name": "{< IngestPipeline "event" >}",
          "if": "ctx.fortinet?.firewall?.type == 'event'"
        }
      },
      {
        "pipeline": {
          "name": "{< IngestPipeline "traffic" >}",
          "if": "ctx.fortinet?.firewall?.type == 'traffic'"
        }
      },
      {
        "pipeline": {
          "name": "{< IngestPipeline "utm" >}",
          "if": "ctx.fortinet?.firewall?.type == 'utm'"
        }
      }
    ],
  "on_failure" : [{
    "set" : {
      "field" : "error.message",
      "value" : "{{ _ingest.on_failure_message }}"
    }
  }]
}
