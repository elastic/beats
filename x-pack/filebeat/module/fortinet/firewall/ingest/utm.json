{
  "description": "Pipeline for parsing fortinet firewall logs (utm pipeline)",
  "processors": [
    {
      "set": {
        "field": "server.ip",
        "value": "{{fortinet.firewall.dstip}}",
        "if": "ctx.fortinet?.firewall?.dstip != null"
      }
    },
    {
      "set": {
        "field": "server.ip",
        "value": "{{fortinet.firewall.remip}}",
        "if": "ctx.fortinet?.firewall?.remip != null && ctx.server?.ip == null"
      }
    },
    {
      "set": {
        "field": "destination.ip",
        "value": "{{fortinet.firewall.dstip}}",
        "if": "ctx.fortinet?.firewall?.dstip != null"
      }
    },
    {
      "set": {
        "field": "destination.ip",
        "value": "{{fortinet.firewall.remip}}",
        "if": "ctx.fortinet?.firewall?.remip != null && ctx.destination?.ip == null"
      }
    },
    {
      "set": {
        "field": "server.port",
        "value": "{{fortinet.firewall.dst_port}}",
        "if": "ctx.fortinet?.firewall?.dst_port != null"
      }
    },
    {
      "set": {
        "field": "server.port",
        "value": "{{fortinet.firewall.remport}}",
        "if": "ctx.fortinet?.firewall?.remport != null && ctx.destination?.port == null"
      }
    },
    {
      "set": {
        "field": "destination.port",
        "value": "{{fortinet.firewall.dst_port}}",
        "if": "ctx.fortinet?.firewall?.dst_port != null"
      }
    },
    {
      "set": {
        "field": "destination.port",
        "value": "{{fortinet.firewall.remport}}",
        "if": "ctx.fortinet?.firewall?.remport != null && ctx.destination?.port == null"
      }
    },
    {
      "set": {
        "field": "server.port",
        "value": "{{fortinet.firewall.dstport}}",
        "if": "ctx.fortinet?.firewall?.dstport != null && ctx.server?.port == null"
      }
    },
    {
      "set": {
        "field": "destination.port",
        "value": "{{fortinet.firewall.dstport}}",
        "if": "ctx.fortinet?.firewall?.dstport != null && ctx.destination?.port == null"
      }
    },
    {
      "set": {
        "field": "server.bytes",
        "value": "{{fortinet.firewall.rcvdbyte}}",
        "if": "ctx.fortinet?.firewall?.rcvdbyte != null"
      }
    },
    {
      "set": {
        "field": "destination.bytes",
        "value": "{{fortinet.firewall.rcvdbyte}}",
        "if": "ctx.fortinet?.firewall?.rcvdbyte != null"
      }
    },
    {
      "set": {
        "field": "server.user.email",
        "value": "{{fortinet.firewall.recipient}}",
        "if": "ctx.fortinet?.firewall?.recipient != null"
      }
    },
    {
      "set": {
        "field": "destination.user.email",
        "value": "{{fortinet.firewall.recipient}}",
        "if": "ctx.fortinet?.firewall?.recipient != null"
      }
    },
    {
      "set": {
        "field": "source.user.group.name",
        "value": "{{fortinet.firewall.group}}",
        "if": "ctx.fortinet?.firewall?.group != null"
      }
    },
    {
      "set": {
        "field": "client.user.group.name",
        "value": "{{fortinet.firewall.group}}",
        "if": "ctx.fortinet?.firewall?.group != null"
      }
    },
    {
      "set": {
        "field": "source.ip",
        "value": "{{fortinet.firewall.locip}}",
        "if": "ctx.fortinet?.firewall?.locip != null"
      }
    },
    {
      "set": {
        "field": "client.ip",
        "value": "{{fortinet.firewall.locip}}",
        "if": "ctx.fortinet?.firewall?.locip != null"
      }
    },
    {
      "set": {
        "field": "source.port",
        "value": "{{fortinet.firewall.locport}}",
        "if": "ctx.fortinet?.firewall?.locport != null"
      }
    },
    {
      "set": {
        "field": "source.port",
        "value": "{{fortinet.firewall.src_port}}",
        "if": "ctx.fortinet?.firewall?.src_port != null && ctx.source.port == null"
      }
    },
    {
      "set": {
        "field": "client.port",
        "value": "{{fortinet.firewall.locport}}",
        "if": "ctx.fortinet?.firewall?.locport != null"
      }
    },
    {
      "set": {
        "field": "client.port",
        "value": "{{fortinet.firewall.src_port}}",
        "if": "ctx.fortinet?.firewall?.src_port != null && ctx.client.port == null"
      }
    },
    {
      "set": {
        "field": "source.bytes",
        "value": "{{fortinet.firewall.sentbyte}}",
        "if": "ctx.fortinet?.firewall?.sentbyte != null"
      }
    },
    {
      "set": {
        "field": "client.bytes",
        "value": "{{fortinet.firewall.sentbyte}}",
        "if": "ctx.fortinet?.firewall?.sentbyte != null"
      }
    },
    {
      "set": {
        "field": "source.domain",
        "value": "{{fortinet.firewall.srcdomain}}",
        "if": "ctx.fortinet?.firewall?.srcdomain != null"
      }
    },
    {
      "set": {
        "field": "client.domain",
        "value": "{{fortinet.firewall.srcdomain}}",
        "if": "ctx.fortinet?.firewall?.srcdomain != null"
      }
    },
    {
      "set": {
        "field": "source.ip",
        "value": "{{fortinet.firewall.srcip}}",
        "if": "ctx.fortinet?.firewall?.srcip != null && ctx.source?.ip == null"
      }
    },
    {
      "set": {
        "field": "client.ip",
        "value": "{{fortinet.firewall.srcip}}",
        "if": "ctx.fortinet?.firewall?.srcip != null && ctx.client?.ip == null"
      }
    },
    {
      "set": {
        "field": "source.mac",
        "value": "{{fortinet.firewall.srcmac}}",
        "if": "ctx.fortinet?.firewall?.srcmac != null"
      }
    },
    {
      "set": {
        "field": "client.mac",
        "value": "{{fortinet.firewall.srcmac}}",
        "if": "ctx.fortinet?.firewall?.srcmac != null"
      }
    },
    {
      "set": {
        "field": "source.port",
        "value": "{{fortinet.firewall.srcport}}",
        "if": "ctx.fortinet?.firewall?.srcport != null && ctx.source?.port == null"
      }
    },
    {
      "set": {
        "field": "client.port",
        "value": "{{fortinet.firewall.srcport}}",
        "if": "ctx.fortinet?.firewall?.srcport != null && ctx.client?.port == null"
      }
    },
    {
      "set": {
        "field": "source.user.name",
        "value": "{{fortinet.firewall.unauthuser}}",
        "if": "ctx.fortinet?.firewall?.unauthuser != null"
      }
    },
    {
      "set": {
        "field": "source.user.name",
        "value": "{{fortinet.firewall.user}}",
        "if": "ctx.fortinet?.firewall?.user != null && ctx.source?.user?.name == null"
      }
    },
    {
      "set": {
        "field": "client.user.name",
        "value": "{{fortinet.firewall.unauthuser}}",
        "if": "ctx.fortinet?.firewall?.unauthuser != null"
      }
    },
    {
      "set": {
        "field": "client.user.name",
        "value": "{{fortinet.firewall.user}}",
        "if": "ctx.fortinet?.firewall?.user != null && ctx.client?.user?.name == null"
      }
    },
    {
      "set": {
        "field": "source.user.email",
        "value": "{{fortinet.firewall.sender}}",
        "if": "ctx.fortinet?.firewall?.sender != null"
      }
    },
    {
      "set": {
        "field": "client.user.email",
        "value": "{{fortinet.firewall.sender}}",
        "if": "ctx.fortinet?.firewall?.sender != null"
      }
    },
    {
      "set": {
        "field": "source.user.email",
        "value": "{{fortinet.firewall.from}}",
        "if": "ctx.fortinet?.firewall?.from != null && ctx.source?.user?.email == null"
      }
    },
    {
      "set": {
        "field": "client.user.email",
        "value": "{{fortinet.firewall.from}}",
        "if": "ctx.fortinet?.firewall?.from != null && ctx.client?.user?.email == null"
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.agent",
        "target_field": "user_agent.original",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.app",
        "target_field": "network.application",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.appcat",
        "target_field": "rule.category",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.applist",
        "target_field": "rule.ruleset",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.catdesc",
        "target_field": "rule.category",
        "ignore_missing": true,
        "if": "ctx.rule?.category == null"
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.devid",
        "target_field": "observer.serial_number",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.dir",
        "target_field": "network.direction",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.direction",
        "target_field": "network.direction",
        "ignore_missing": true,
        "if": "ctx.network?.direction == null"
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.dst_int",
        "target_field": "observer.egress.interface.name",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.dstintf",
        "target_field": "observer.egress.interface.name",
        "ignore_missing": true,
        "if": "ctx.observer?.egress?.interface?.name == null"
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.dstintf",
        "target_field": "observer.egress.interface.name",
        "ignore_missing": true,
        "if": "ctx.observer?.egress?.interface?.name == null"
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.duration",
        "target_field": "event.duration",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.error",
        "target_field": "event.message",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.errorcode",
        "target_field": "event.code",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.event_id",
        "target_field": "event.id",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.eventid",
        "target_field": "event.id",
        "ignore_missing": true,
        "if": "ctx.event?.id == null"
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.eventtype",
        "target_field": "event.action",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.filename",
        "target_field": "file.name",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.filesize",
        "target_field": "file.size",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.filetype",
        "target_field": "file.extension",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.infectedfilename",
        "target_field": "file.name",
        "ignore_missing": true,
        "if": "ctx.file?.name == null"
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.infectedfilesize",
        "target_field": "file.size",
        "ignore_missing": true,
        "if": "ctx.file?.size == null"
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.infectedfiletype",
        "target_field": "file.extension",
        "ignore_missing": true,
        "if": "ctx.file?.extension == null"
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.matchedfilename",
        "target_field": "file.name",
        "ignore_missing": true,
        "if": "ctx.file?.name == null"
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.matchedfiletype",
        "target_field": "file.extension",
        "ignore_missing": true,
        "if": "ctx.file?.extension == null"
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.hostname",
        "target_field": "url.domain",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.ipaddr",
        "target_field": "dns.resolved_ip",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.level",
        "target_field": "log.level",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.logid",
        "target_field": "event.code",
        "ignore_missing": true,
        "if": "ctx.event?.code == null"
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.msg",
        "target_field": "message",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.policy_id",
        "target_field": "rule.id",
        "ignore_missing": true,
        "if": "ctx.rule?.id == null"
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.policyid",
        "target_field": "rule.id",
        "ignore_missing": true,
        "if": "ctx.rule?.id == null"
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.profile",
        "target_field": "rule.ruleset",
        "ignore_missing": true,
        "if": "ctx.rule?.ruleset == null"
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.proto",
        "target_field": "network.iana_number",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.qclass",
        "target_field": "dns.question.class",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.qname",
        "target_field": "dns.question.name",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.qtype",
        "target_field": "dns.question.type",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.reason",
        "target_field": "event.reason",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.service",
        "target_field": "network.protocol",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.src_int",
        "target_field": "observer.ingress.interface.name",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.srcintf",
        "target_field": "observer.ingress.interface.name",
        "ignore_missing": true,
        "if": "ctx.observer?.ingress?.interface?.name == null"
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.url",
        "target_field": "url.path",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.xid",
        "target_field": "dns.id",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.scertname",
        "target_field": "tls.client.server_name",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.scertissuer",
        "target_field": "tls.server.issuer",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.ccertissuer",
        "target_field": "tls.client.issuer",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.sender",
        "target_field": "tls.server.issuer",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.dtype",
        "target_field": "vulnerability.category",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "fortinet.firewall.ref",
        "target_field": "event.reference",
        "ignore_missing": true
      }
    },
    {
      "remove": {
        "field": [
          "fortinet.firewall.locip",
          "fortinet.firewall.locport",
          "fortinet.firewall.srcip",
          "fortinet.firewall.src_ip",
          "fortinet.firewall.src_port",
          "fortinet.firewall.srcport",
          "fortinet.firewall.srcdomain",
          "fortinet.firewall.srcmac",
          "fortinet.firewall.unauthuser",
          "fortinet.firewall.user",
          "fortinet.firewall.sentbyte",
          "fortinet.firewall.rcvdbyte",
          "fortinet.firewall.remip",
          "fortinet.firewall.remport",
          "fortinet.firewall.dstport",
          "fortinet.firewall.dst_port",
          "fortinet.firewall.dstip",
          "fortinet.firewall.recipient"
        ],
        "ignore_missing": true
      }
    }
  ],
  "on_failure": [
    {
      "set": {
        "field": "error.message",
        "value": "{{ _ingest.on_failure_message }}"
      }
    }
  ]
}