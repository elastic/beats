---

# This file contains the package specifications for Functionbeat.

shared:
  - &common
    name: '{{.BeatName}}-{{.Provider}}'
    service_name: '{{.BeatServiceName}}-{{.Provider}}'
    os: '{{.GOOS}}'
    arch: '{{.PackageArch}}'
    vendor: '{{.BeatVendor}}'
    version: '{{ beat_version }}'
    license: '{{.BeatLicense}}'
    url: '{{.BeatURL}}'
    description: '{{.BeatDescription}}'
    extra_vars:
      provider: ''

  - &binary_files
    '{{.BeatName}}-{{.Provider}}{{.BinaryExt}}':
      source: '{{.Provider}}/build/golang-crossbuild/{{.Provider}}-{{.GOOS}}-{{.Platform.Arch}}{{.BinaryExt}}'
      mode: 0755
    fields.yml:
      source: fields.yml
      mode: 0644
    LICENSE.txt:
      source: '{{ repo.RootDir }}/LICENSE.txt'
      mode: 0644
    NOTICE.txt:
      source: '{{ repo.RootDir }}/NOTICE.txt'
      mode: 0644
    README.md:
      template: '{{ elastic_beats_dir }}/dev-tools/packaging/templates/common/README.md.tmpl'
      mode: 0644
    .build_hash.txt:
      content: >
        {{ commit }}
      mode: 0644
    '{{.BeatName}}-{{.Provider}}.reference.yml':
      source: '{{.Provider}}/{{.BeatName}}-{{.Provider}}.reference.yml'
      mode: 0644
    '{{.BeatName}}-{{.Provider}}.yml':
      source: '{{.Provider}}/{{.BeatName}}-{{.Provider}}.yml'
      mode: 0600
      config: true
    kibana:
      source: _meta/kibana.generated
      mode: 0644

  # Binary package spec (tar.gz for linux/darwin)
  - &binary_spec
    <<: *common
    files:
      <<: *binary_files

  #
  # License modifiers for the Elastic License
  #
  - &elastic_license_for_binaries
    license: "Elastic License"
    files:
      LICENSE.txt:
        source: '{{ repo.RootDir }}/licenses/ELASTIC-LICENSE.txt'
        mode: 0644
  #
  # Binaries used to run the function.
  #
  - &functionbeat_binaries
    files:
      'pkg/functionbeat-{{.Provider}}':
        source: '{{.Provider}}/build/golang-crossbuild/{{.BeatName}}-{{.Provider}}-linux-amd64'
        mode: 0755
    output_file: "build/distribution/{{.BeatName}}-{{.Provider}}-{{ beat_version }}{{if .Snapshot}}-SNAPSHOT{{end}}{{if .OS}}-{{.OS}}{{end}}{{if .Arch}}-{{.Arch}}{{end}}"
# specs is a list of named packaging "flavors".
specs:
  functionbeat:
    ###
    # Elastic Licensed Packages
    ###
    - os: windows
      types: [zip]
      spec:
        <<: *binary_spec
        <<: *functionbeat_binaries
        <<: *elastic_license_for_binaries
        files:
          '{{.BeatName}}-{{.Provider}}{{.BinaryExt}}':
            source: '{{.Provider}}/build/golang-crossbuild/{{.BeatName}}-{{.Provider}}-{{.GOOS}}-{{.Platform.Arch}}{{.BinaryExt}}'

    - os: darwin
      types: [tgz]
      spec:
        <<: *binary_spec
        <<: *functionbeat_binaries
        <<: *elastic_license_for_binaries
        files:
          '{{.BeatName}}-{{.Provider}}{{.BinaryExt}}':
            source: '{{.Provider}}/build/golang-crossbuild/{{.BeatName}}-{{.Provider}}-{{.GOOS}}-{{.Platform.Arch}}{{.BinaryExt}}'

    - os: linux
      types: [tgz]
      spec:
        <<: *binary_spec
        <<: *functionbeat_binaries
        <<: *elastic_license_for_binaries
        files:
          '{{.BeatName}}-{{.Provider}}{{.BinaryExt}}':
            source: '{{.Provider}}/build/golang-crossbuild/{{.BeatName}}-{{.Provider}}-{{.GOOS}}-{{.Platform.Arch}}{{.BinaryExt}}'
