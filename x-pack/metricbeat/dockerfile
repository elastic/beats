# Multi-stage build for x-pack metricbeat
FROM golang:1.24.11-bookworm AS builder

# Install build dependencies
RUN apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get install -qq -y --no-install-recommends \
    python3 \
    python3-dev \
    python3-pip \
    python3-venv \
    make \
    git \
    && rm -rf /var/lib/apt/lists/*

# Set up Python virtual environment
ENV VIRTUAL_ENV=/opt/venv
RUN python3 -m venv $VIRTUAL_ENV
ENV PATH="$VIRTUAL_ENV/bin:$PATH"

RUN pip3 install --upgrade pip==20.1.1 && \
    pip3 install --upgrade setuptools==47.3.2 && \
    pip3 install --upgrade PyYAML==6.0.1

# Install mage
RUN go install github.com/magefile/mage@latest

# Set working directory
WORKDIR /go/src/github.com/elastic/beats

# Copy the entire beats repository (needed for shared dependencies)
COPY . .

# Build x-pack metricbeat
WORKDIR /go/src/github.com/elastic/beats/x-pack/metricbeat
RUN go mod download
RUN mage build

# Final runtime image
FROM debian:bookworm-slim

# Install runtime dependencies
RUN apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get install -qq -y --no-install-recommends \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Copy the built binary and configuration files
COPY --from=builder /go/src/github.com/elastic/beats/x-pack/metricbeat/metricbeat /usr/share/metricbeat/metricbeat
COPY --from=builder /go/src/github.com/elastic/beats/x-pack/metricbeat/metricbeat.yml /etc/metricbeat/metricbeat.yml
COPY --from=builder /go/src/github.com/elastic/beats/x-pack/metricbeat/metricbeat.reference.yml /etc/metricbeat/metricbeat.reference.yml
COPY --from=builder /go/src/github.com/elastic/beats/x-pack/metricbeat/modules.d /etc/metricbeat/modules.d

WORKDIR /usr/share/metricbeat

# Create data directory
RUN mkdir -p /var/lib/metricbeat /var/log/metricbeat

ENTRYPOINT ["/usr/share/metricbeat/metricbeat"]
CMD ["-e", "-c", "/etc/metricbeat/metricbeat.yml"]
