# DO NOT EDIT - AUTO-GENERATED
# This file was generated by 'mage update:travisCI' from a template at
# dev-tools/ci/templates/travis.yml.tmpl.

sudo: required
dist: trusty
services:
  - docker

python: 2.7.14

language: go

go_import_path: github.com/elastic/beats

stages:
  - name: check
  - name: test
  - name: crosscompile
    if: type != pull_request

env:
  global:
    # Cross-compile for amd64 only to speed up testing.
    - GOX_FLAGS="-arch amd64"

    # Build snapshots when testing packaging.
    - SNAPSHOT=true

    # Dependency version.
    - DOCKER_COMPOSE_VERSION=1.21.0
    - GO_VERSION="$(cat .go-version)"
    # Newer versions of minikube fail on travis. See https://github.com/kubernetes/minikube/issues/2704.
    - TRAVIS_MINIKUBE_VERSION=v0.25.2

    # Set Python version returned by pyenv.
    - PYENV_VERSION=2.7.14

jobs:
  include:
    - os: linux
      go: $GO_VERSION
      stage: check
      env:
        - BUILD_CMD="mage"
        - TARGETS="check"

    - os: linux
      go: $GO_VERSION
      stage: test
      env:
        - BUILD_CMD="mage -d libbeat"
        - TARGETS="unitTest integTest"

    - os: osx
      go: $GO_VERSION
      stage: test
      env:
        - BUILD_CMD="mage -d libbeat"
        - TARGETS="unitTest"

    - os: linux
      go: $GO_VERSION
      stage: test
      env:
        - BUILD_CMD="mage -d auditbeat"
        - TARGETS="unitTest integTest"

    - os: osx
      go: $GO_VERSION
      stage: test
      env:
        - BUILD_CMD="mage -d auditbeat"
        - TARGETS="unitTest"

    - os: linux
      go: $GO_VERSION
      stage: test
      env:
        - BUILD_CMD="mage -d filebeat"
        - TARGETS="unitTest integTest"

    - os: osx
      go: $GO_VERSION
      stage: test
      env:
        - BUILD_CMD="mage -d filebeat"
        - TARGETS="unitTest"

    - os: linux
      go: $GO_VERSION
      stage: test
      env:
        - BUILD_CMD="mage -d heartbeat"
        - TARGETS="unitTest integTest"

    - os: osx
      go: $GO_VERSION
      stage: test
      env:
        - BUILD_CMD="mage -d heartbeat"
        - TARGETS="unitTest"

    - os: linux
      go: $GO_VERSION
      stage: test
      env:
        - BUILD_CMD="mage -d journalbeat"
        - TARGETS="integTest"

    - os: linux
      go: $GO_VERSION
      stage: test
      env:
        - BUILD_CMD="mage -d metricbeat"
        - TARGETS="unitTest integTest"

    - os: osx
      go: $GO_VERSION
      stage: test
      env:
        - BUILD_CMD="mage -d metricbeat"
        - TARGETS="unitTest"

    - os: linux
      go: $GO_VERSION
      stage: test
      env:
        - BUILD_CMD="mage -d packetbeat"
        - TARGETS="unitTest"

    - os: osx
      go: $GO_VERSION
      stage: test
      env:
        - BUILD_CMD="mage -d packetbeat"
        - TARGETS="unitTest"

    - os: linux
      go: $GO_VERSION
      stage: test
      env:
        - BUILD_CMD="mage -d winlogbeat"
        - TARGETS="unitTest"

    - os: linux
      go: $GO_VERSION
      stage: test
      env:
        - BUILD_CMD="mage -d x-pack/libbeat"
        - TARGETS="unitTest"

    - os: linux
      go: $GO_VERSION
      stage: test
      env:
        - BUILD_CMD="mage -d x-pack/auditbeat"
        - TARGETS="unitTest integTest"

    - os: osx
      go: $GO_VERSION
      stage: test
      env:
        - BUILD_CMD="mage -d x-pack/auditbeat"
        - TARGETS="unitTest"

    - os: linux
      go: $GO_VERSION
      stage: test
      env:
        - BUILD_CMD="mage -d x-pack/filebeat"
        - TARGETS="unitTest integTest"

    - os: osx
      go: $GO_VERSION
      stage: test
      env:
        - BUILD_CMD="mage -d x-pack/filebeat"
        - TARGETS="unitTest"

    - os: linux
      go: $GO_VERSION
      stage: test
      env:
        - BUILD_CMD="mage -d x-pack/functionbeat"
        - TARGETS="unitTest integTest"

    - os: linux
      go: $GO_VERSION
      stage: test
      env:
        - BUILD_CMD="mage"
        - TARGETS="docs"

    - os: linux
      go: $GO_VERSION
      stage: crosscompile
      env:
        - BUILD_CMD="make -C libbeat"
        - TARGETS="gox"

    - os: linux
      go: $GO_VERSION
      stage: crosscompile
      env:
        - BUILD_CMD="make -C auditbeat"
        - TARGETS="gox"

    - os: linux
      go: $GO_VERSION
      stage: crosscompile
      env:
        - BUILD_CMD="make -C filebeat"
        - TARGETS="gox"

    - os: linux
      go: $GO_VERSION
      stage: crosscompile
      env:
        - BUILD_CMD="make -C heartbeat"
        - TARGETS="gox"

    - os: linux
      go: $GO_VERSION
      stage: crosscompile
      env:
        - BUILD_CMD="make -C journalbeat"
        - TARGETS="gox"

    - os: linux
      go: $GO_VERSION
      stage: crosscompile
      env:
        - BUILD_CMD="make -C metricbeat"
        - TARGETS="gox"

    - os: linux
      go: $GO_VERSION
      stage: crosscompile
      env:
        - BUILD_CMD="make -C packetbeat"
        - TARGETS="gox"

    - os: linux
      go: $GO_VERSION
      stage: crosscompile
      env:
        - BUILD_CMD="make -C winlogbeat"
        - TARGETS="gox"

    - os: linux
      go: $GO_VERSION
      stage: crosscompile
      env:
        - BUILD_CMD="make -C x-pack/libbeat"
        - TARGETS="gox"

    - os: linux
      go: $GO_VERSION
      stage: crosscompile
      env:
        - BUILD_CMD="make -C x-pack/auditbeat"
        - TARGETS="gox"

    - os: linux
      go: $GO_VERSION
      stage: crosscompile
      env:
        - BUILD_CMD="make -C x-pack/filebeat"
        - TARGETS="gox"

    - os: linux
      go: $GO_VERSION
      stage: crosscompile
      env:
        - BUILD_CMD="make -C x-pack/functionbeat"
        - TARGETS="gox"

    - os: linux
      go: $GO_VERSION
      stage: crosscompile
      env:
        - BUILD_CMD="make -C x-pack/heartbeat"
        - TARGETS="gox"

    - os: linux
      go: $GO_VERSION
      stage: crosscompile
      env:
        - BUILD_CMD="make -C x-pack/journalbeat"
        - TARGETS="gox"

    - os: linux
      go: $GO_VERSION
      stage: crosscompile
      env:
        - BUILD_CMD="make -C x-pack/metricbeat"
        - TARGETS="gox"

    - os: linux
      go: $GO_VERSION
      stage: crosscompile
      env:
        - BUILD_CMD="make -C x-pack/packetbeat"
        - TARGETS="gox"

    - os: linux
      go: $GO_VERSION
      stage: crosscompile
      env:
        - BUILD_CMD="make -C x-pack/winlogbeat"
        - TARGETS="gox"

    # Generators
    - os: linux
      env:
        - TARGETS="-C generator/metricbeat test"
      go: $GO_VERSION
      stage: test
    - os: linux
      env:
        - TARGETS="-C generator/beat test"
      go: $GO_VERSION
      stage: test

    # Kubernetes
    - os: linux
      go: $GO_VERSION
      stage: test
      install: deploy/kubernetes/.travis/setup.sh
      env:
        - TRAVIS_K8S_VERSION=v1.8.0
        - BUILD_CMD="mage -d deploy/kubernetes"
        - TARGETS="integTest"
    - os: linux
      go: $GO_VERSION
      stage: test
      install: deploy/kubernetes/.travis/setup.sh
      env:
        - TRAVIS_K8S_VERSION=v1.9.4
        - BUILD_CMD="mage -d deploy/kubernetes"
        - TARGETS="integTest"
    - os: linux
      go: $GO_VERSION
      stage: test
      install: deploy/kubernetes/.travis/setup.sh
      env:
        - TRAVIS_K8S_VERSION=v1.10.0
        - BUILD_CMD="mage -d deploy/kubernetes"
        - TARGETS="integTest"

addons:
  apt:
    update: true
    packages:
      - python-virtualenv
      - xsltproc
      - libxml2-utils
      # For Packetbeat and Filebeat netflow.
      - libpcap-dev
      # For building journalbeat.
      - libsystemd-journal-dev

before_install:
  # Use conservative file modes when creating files.
  - umask 022
  - chmod -R go-w $GOPATH/src/github.com/elastic/beats

  # Docker-compose installation.
  - sudo rm /usr/local/bin/docker-compose || true
  - curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > docker-compose
  - chmod +x docker-compose
  - sudo mv docker-compose /usr/local/bin

  # Python setup.
  - python --version
  ## Tell virtualenv where to find Python.
  - >
    if [ "$TRAVIS_OS_NAME" != "osx" ]; then
      pyenv versions;
      export VIRTUALENV_PYTHON=$(pyenv prefix $PYENV_VERSION)/bin/python;
    fi
  - if [ "$TRAVIS_OS_NAME" == "osx" ]; then pip install virtualenv; fi

  # Mage tool setup.
  - make mage

script:
  - ${BUILD_CMD:-make} $TARGETS

after_failure:
  - /home/travis/gopath/src/github.com/elastic/beats/build/ve/linux/bin/python --version || true
  - cat /home/travis/gopath/src/github.com/elastic/beats/journalbeat/build/system-tests/run/test*/journalbeat.log || true

notifications:
  slack:
    on_success: change
    on_failure: always
    on_pull_requests: false
    rooms:
      secure: "e25J5puEA31dOooTI4T+K+zrTs8XeWIGq2cgmiPt9u/g7eqWeQj1UJnVsr8GOu1RPDyuJZJHXqfrvuOYJTdHzXbwjD0JTbwwVVZMkkZW2SWZHG46HCXPiucjWXEr3hXJKBJDDpIx6VxrN7r17dejv1biQ8QuEFZfiB1H8kbH/ho="

after_success:
  # Copy full.cov to coverage.txt because codecov.io requires this file
  - test -f auditbeat/build/coverage/full.cov && bash <(curl -s https://codecov.io/bash) -f auditbeat/build/coverage/full.cov
  - test -f filebeat/build/coverage/full.cov && bash <(curl -s https://codecov.io/bash) -f filebeat/build/coverage/full.cov
  - test -f heartbeat/build/coverage/full.cov && bash <(curl -s https://codecov.io/bash) -f heartbeat/build/coverage/full.cov
  - test -f libbeat/build/coverage/full.cov && bash <(curl -s https://codecov.io/bash) -f libbeat/build/coverage/full.cov
  - test -f metricbeat/build/coverage/full.cov && bash <(curl -s https://codecov.io/bash) -f metricbeat/build/coverage/full.cov
  - test -f packetbeat/build/coverage/full.cov && bash <(curl -s https://codecov.io/bash) -f packetbeat/build/coverage/full.cov
