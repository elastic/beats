# yaml-language-server: $schema=https://raw.githubusercontent.com/buildkite/pipeline-schema/main/schema.json
env:
  SETUP_GVM_VERSION: 'v0.5.1'
  SETUP_MAGE_VERSION: '1.13.0'
  IMAGE_UBUNTU_X86_64: "family/core-ubuntu-2204"

steps:

#   - group: "Mandatory Tests"
#     key: "mandatory-tests"
# #    if: define_condition_if_needed_for_group
#     steps:
#       - label: ":linux: Ubuntu unit tests"
#         key: "mandatory-linux-unit-test"
#         command: ".buildkite/metricbeat/scripts/unit-tests.sh"
#         agents:
#           provider: "gcp"
#           image: "${IMAGE_UBUNTU_X86_64}"
#           machineType: "c2-standard-16"

#       - label: "Go Intergration Test"
#         key: "mandatory-int-test"
#         command:
#           - "cd metricbeat"
#           - "mage goIntegTest"
#         agents:
#           provider: "gcp"
#           image: "${IMAGE_UBUNTU_X86_64}"
#           machineType: "c2-standard-16"

#       - label: ":python: Python Integration Test"
#         key: "mandatory-python-int-test"
#         command:
#           - "cd metricbeat"
#           - "mage pythonIntegTest"
#         agents:
#           provider: "gcp"
#           image: "${IMAGE_UBUNTU_X86_64}"
#           machineType: "c2-standard-16"

#       - label: ":negative_squared_cross_mark: Cross compile"
#         key: "mandatory-cross-compile"
#         command: "make -C metricbeat crosscompile"
#         agents:
#           provider: "gcp"
#           image: "${IMAGE_UBUNTU_X86_64}"
#           machineType: "c2-standard-16"

  - group: "Extended Tests"
    key: "extended-tests"
#    if: define_condition_if_needed_for_group
    steps:

      - label: ":mac: MacOS Unit Tests"
        key: "extended-macos-unit-tests"
        # if: build.env("GITHUB_PR_TRIGGER_COMMENT") == "/test metricbeat for macos" || build.env("GITHUB_PR_LABELS") =~ /.*macOS.*/ || build.env("BUILDKITE_TAG") != ""
        command:
          - "ulimit -Sn 50000"
          - ".buildkite/metricbeat/scripts/unit-tests.sh"
        agents:
          provider: "orka"
          imagePrefix: "generic-13-ventura-x64"


  # - label: "MacOS unit test"
  #   command:
  #     cd metricbeat
  #     mage build unitTest
  # Ignore as long as there are test failures, see https://github.com/elastic/beats/issues/33035
  # - label: "MacOS M1"
