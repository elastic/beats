# yaml-language-server: $schema=https://raw.githubusercontent.com/buildkite/pipeline-schema/main/schema.json
env:
  SETUP_GVM_VERSION: 'v0.5.1'
  SETUP_MAGE_VERSION: '1.13.0'
  IMAGE_UBUNTU_X86_64: "family/core-ubuntu-2204"

steps:

  - group: "Mandatory Tests"
    key: "mandatory-tests"
#    if: define_condition_if_needed_for_group
    steps:
      - label: ":linux: Ubuntu unit tests"
        key: "mandatory-linux-unit-test"
        command: ".buildkite/metricbeat/scripts/unit_tests.sh"
        agents:
          provider: "gcp"
          image: "${IMAGE_UBUNTU_X86_64}"
          machineType: "c2-standard-16"

      - label: "Go Intergration Test"
        key: "mandatory-int-test"
        command: ".buildkite/metricbeat/scripts/go_int_tests.sh"
        agents:
          provider: "gcp"
          image: "${IMAGE_UBUNTU_X86_64}"
          machineType: "c2-standard-16"

      - label: ":python: Python Integration Test"
        key: "mandatory-python-int-test"
        command: ".buildkite/metricbeat/scripts/py_int_tests.sh"
        agents:
          provider: "gcp"
          image: "${IMAGE_UBUNTU_X86_64}"
          machineType: "c2-standard-16"

      - label: ":negative_squared_cross_mark: Cross compile"
        key: "mandatory-cross-compile"
        command: ".buildkite/metricbeat/scripts/crosscompile.sh"
        agents:
          provider: "gcp"
          image: "${IMAGE_UBUNTU_X86_64}"
          machineType: "c2-standard-16"

  - group: "Extended Tests"
    key: "extended-tests"
#    if: define_condition_if_needed_for_group
    steps:

      - label: ":mac: MacOS Unit Tests"
        key: "extended-macos-unit-tests"
        # if: build.env("GITHUB_PR_TRIGGER_COMMENT") == "/test metricbeat for macos" || build.env("GITHUB_PR_LABELS") =~ /.*macOS.*/ || build.env("BUILDKITE_TAG") != ""
        command: ".buildkite/metricbeat/scripts/unit_tests.sh"
        agents:
          provider: "orka"
          imagePrefix: "generic-13-ventura-x64"
