# yaml-language-server: $schema=https://raw.githubusercontent.com/buildkite/pipeline-schema/main/schema.json

steps:
  - label: "Trigger Auditbeat"
    if: build.pull_request.id != null
    plugins:
      - monorepo-diff#v1.0.1:
          diff: "git diff --name-only origin/${GITHUB_PR_TARGET_BRANCH}...HEAD"
          interpolation: false
          watch:
            - path:
                - auditbeat/
                - .buildkite/auditbeat/
                - .buildkite/scripts
                - .buildkite/hooks/
                #OSS
                - go.mod
                - pytest.ini
                - dev-tools/
                - libbeat/**
                - testing/**
              config:
                trigger: "auditbeat"
                build:
                  commit: "${BUILDKITE_COMMIT}"
                  branch: "${BUILDKITE_BRANCH}"
                  env:
                    - BUILDKITE_PULL_REQUEST=${BUILDKITE_PULL_REQUEST}
                    - BUILDKITE_PULL_REQUEST_BASE_BRANCH=${BUILDKITE_PULL_REQUEST_BASE_BRANCH}
                    - GITHUB_PR_LABELS=${GITHUB_PR_LABELS}

  - label: "Triggering Build for Auditbeat"
    if: build.pull_request.id == null
    trigger: "auditbeat"
    build:
      commit: "${BUILDKITE_COMMIT}"
      branch: "${BUILDKITE_BRANCH}"

  - label: "Trigger Heartbeat"
    if: build.pull_request.id != null
    plugins:
      - monorepo-diff#v1.0.1:
          diff: "git diff --name-only origin/${GITHUB_PR_TARGET_BRANCH}...HEAD"
          interpolation: false
          watch:
            - path:
                - heartbeat/
                - .buildkite/heartbeat/
                - .buildkite/scripts
                - .buildkite/hooks/
                #OSS
                - go.mod
                - pytest.ini
                - dev-tools/
                - libbeat/**
                - testing/**
              config:
                trigger: "heartbeat"
                build:
                  commit: "${BUILDKITE_COMMIT}"
                  branch: "${BUILDKITE_BRANCH}"
                  env:
                    - BUILDKITE_PULL_REQUEST=${BUILDKITE_PULL_REQUEST}
                    - BUILDKITE_PULL_REQUEST_BASE_BRANCH=${BUILDKITE_PULL_REQUEST_BASE_BRANCH}
                    - GITHUB_PR_LABELS=${GITHUB_PR_LABELS}

  - label: "Triggering Build for Heartbeat"
    if: build.pull_request.id == null
    trigger: "heartbeat"
    build:
      commit: "${BUILDKITE_COMMIT}"
      branch: "${BUILDKITE_BRANCH}"

  - label: "Trigger Filebeat"
    if: build.pull_request.id != null
    plugins:
      - monorepo-diff#v1.0.1:
          diff: "git diff --name-only origin/${GITHUB_PR_TARGET_BRANCH}...HEAD"
          interpolation: false
          watch:
            - path:
                - filebeat/
                - .buildkite/filebeat/
                # CI related scripts
                - .buildkite/scripts
                - .buildkite/hooks/
                #OSS
                - go.mod
                - pytest.ini
                - dev-tools
                - libbeat/**
                - testing/**
              config:
                trigger: "filebeat"
                build:
                  commit: "${BUILDKITE_COMMIT}"
                  branch: "${BUILDKITE_BRANCH}"
                  env:
                    - BUILDKITE_PULL_REQUEST=${BUILDKITE_PULL_REQUEST}
                    - BUILDKITE_PULL_REQUEST_BASE_BRANCH=${BUILDKITE_PULL_REQUEST_BASE_BRANCH}
                    - GITHUB_PR_LABELS=${GITHUB_PR_LABELS}

  - label: "Triggering Build for Filebeat"
    if: build.pull_request.id == null
    trigger: "filebeat"
    build:
      commit: "${BUILDKITE_COMMIT}"
      branch: "${BUILDKITE_BRANCH}"

  - label: "Trigger x-pack/filebeat"
    if: build.pull_request.id != null
    plugins:
      - monorepo-diff#v1.0.1:
          diff: "git diff --name-only origin/${GITHUB_PR_TARGET_BRANCH}...HEAD"
          interpolation: false
          watch:
            - path:
                - filebeat/
                - x-pack/filebeat/
                - x-pack/libbeat/
                - .buildkite/x-pack/pipeline.xpack.filebeat.yml
                - .buildkite/scripts
                - .buildkite/hooks/
                - .buildkite/deploy/docker/docker-compose.yml
                #OSS
                - go.mod
                - pytest.ini
                - dev-tools/
                - libbeat/**
                - testing/**
              config:
                label: ":pipeline: Upload beats-xpack-filebeat"
                command: "buildkite-agent pipeline upload .buildkite/x-pack/pipeline.xpack.filebeat.yml"
                env:
                  - BUILDKITE_PULL_REQUEST=${BUILDKITE_PULL_REQUEST}
                  - BUILDKITE_PULL_REQUEST_BASE_BRANCH=${BUILDKITE_PULL_REQUEST_BASE_BRANCH}
                  - GITHUB_PR_LABELS=${GITHUB_PR_LABELS}

  - label: ":pipeline: Upload beats-xpack-filebeat"
    if: build.pull_request.id == null
    command: "buildkite-agent pipeline upload .buildkite/x-pack/pipeline.xpack.filebeat.yml"

  - label: "Trigger x-pack/dockerlogbeat"
    if: build.pull_request.id != null
    plugins:
      - monorepo-diff#v1.0.1:
          diff: "git diff --name-only origin/${GITHUB_PR_TARGET_BRANCH}...HEAD"
          interpolation: false
          watch:
            - path:
                - x-pack/dockerlogbeat/
                - .buildkite/x-pack/pipeline.xpack.dockerlogbeat.yml
                - .buildkite/hooks/
                - .buildkite/scripts
                #OSS
                - go.mod
                - pytest.ini
                - dev-tools/
                - libbeat/**
                - testing/**
              config:
                label: ":pipeline: beats-xpack-dockerlogbeat"
                command: "buildkite-agent pipeline upload .buildkite/x-pack/pipeline.xpack.dockerlogbeat.yml"
                env:
                  - BUILDKITE_PULL_REQUEST=${BUILDKITE_PULL_REQUEST}
                  - BUILDKITE_PULL_REQUEST_BASE_BRANCH=${BUILDKITE_PULL_REQUEST_BASE_BRANCH}
                  - GITHUB_PR_LABELS=${GITHUB_PR_LABELS}

  - label: ":pipeline: Upload beats-xpack-dockerlogbeat"
    if: build.pull_request.id == null
    command: "buildkite-agent pipeline upload .buildkite/x-pack/pipeline.xpack.dockerlogbeat.yml"

  - label: "Trigger Metricbeat"
    if: build.pull_request.id != null
    plugins:
      - monorepo-diff#v1.0.1:
          diff: "git diff --name-only origin/${GITHUB_PR_TARGET_BRANCH}...HEAD"
          interpolation: false
          watch:
            - path:
                - metricbeat/
                - .buildkite/metricbeat/
                - .buildkite/scripts
                - .buildkite/hooks/
                #OSS
                - go.mod
                - pytest.ini
                - dev-tools/
                - libbeat/**
                - testing/**
              config:
                label: ":pipeline: beats-metricbeat"
                command: "buildkite-agent pipeline upload .buildkite/metricbeat/pipeline.yml"
                env:
                  - BUILDKITE_PULL_REQUEST=${BUILDKITE_PULL_REQUEST}
                  - BUILDKITE_PULL_REQUEST_BASE_BRANCH=${BUILDKITE_PULL_REQUEST_BASE_BRANCH}
                  - GITHUB_PR_LABELS=${GITHUB_PR_LABELS}

  - label: ":pipeline: Upload beats-metricbeat"
    if: build.pull_request.id == null
    command: "buildkite-agent pipeline upload .buildkite/metricbeat/pipeline.yml"

  - label: "Trigger x-pack/metricbeat"
    if: build.pull_request.id != null
    plugins:
      - monorepo-diff#v1.0.1:
          diff: "git diff --name-only origin/${GITHUB_PR_TARGET_BRANCH}...HEAD"
          interpolation: false
          watch:
            - path:
                - metricbeat/
                - x-pack/metricbeat/
                - x-pack/libbeat/common/aws
                - .buildkite/x-pack/pipeline.xpack.metricbeat.yml
                - .buildkite/scripts
                - .buildkite/hooks/
                - .buildkite/deploy/docker/docker-compose.yml
                #OSS
                - go.mod
                - pytest.ini
                - dev-tools/
                - libbeat/**
                - testing/**
              config:
                label: ":pipeline: beats-xpack-metricbeat"
                command: "buildkite-agent pipeline upload .buildkite/x-pack/pipeline.xpack.metricbeat.yml"
                env:
                  - BUILDKITE_PULL_REQUEST=${BUILDKITE_PULL_REQUEST}
                  - BUILDKITE_PULL_REQUEST_BASE_BRANCH=${BUILDKITE_PULL_REQUEST_BASE_BRANCH}
                  - GITHUB_PR_LABELS=${GITHUB_PR_LABELS}

  - label: ":pipeline: Upload beats-xpack-metricbeat"
    if: build.pull_request.id == null
    command: "buildkite-agent pipeline upload .buildkite/x-pack/pipeline.xpack.metricbeat.yml"

  - label: "Trigger x-pack/osquerybeat"
    if: build.pull_request.id != null
    plugins:
      - monorepo-diff#v1.0.1:
          diff: "git diff --name-only origin/${GITHUB_PR_TARGET_BRANCH}...HEAD"
          interpolation: false
          watch:
            - path:
                - x-pack/osquerybeat/**
                - .buildkite/x-pack/pipeline.xpack.osquerybeat.yml
                - .buildkite/scripts/**
                - .buildkite/hooks/**
                # x-pack
                - libbeat/**
                - x-pack/libbeat/**
                #OSS
                - go.mod
                - pytest.ini
                - dev-tools/
                - libbeat/**
                - testing/**
              config:
                label: ":pipeline: beats-xpack-osquerybeat"
                command: "buildkite-agent pipeline upload .buildkite/x-pack/pipeline.xpack.winlogbeat.yml"
                env:
                  - BUILDKITE_PULL_REQUEST=${BUILDKITE_PULL_REQUEST}
                  - BUILDKITE_PULL_REQUEST_BASE_BRANCH=${BUILDKITE_PULL_REQUEST_BASE_BRANCH}
                  - GITHUB_PR_LABELS=${GITHUB_PR_LABELS}

  - label: ":pipeline: Upload beats-xpack-osquerybeat"
    if: build.pull_request.id == null
    command: "buildkite-agent pipeline upload .buildkite/x-pack/pipeline.xpack.osquerybeat.yml"


  - label: "Trigger x-pack/winlogbeat"
    if: build.pull_request.id != null
    plugins:
      - monorepo-diff#v1.0.1:
          diff: "git diff --name-only origin/${GITHUB_PR_TARGET_BRANCH}...HEAD"
          interpolation: false
          watch:
            - path:
                - winlogbeat/
                - x-pack/winlogbeat/
                - .buildkite/x-pack/pipeline.xpack.winlogbeat.yml
                - .buildkite/scripts
                - .buildkite/hooks/
                #OSS
                - go.mod
                - pytest.ini
                - dev-tools/**
                - libbeat/**
                - testing/**
              config:
                label: ":pipeline: beats-xpack-winlogbeat"
                command: "buildkite-agent pipeline upload .buildkite/x-pack/pipeline.xpack.winlogbeat.yml"
                env:
                  - BUILDKITE_PULL_REQUEST=${BUILDKITE_PULL_REQUEST}
                  - BUILDKITE_PULL_REQUEST_BASE_BRANCH=${BUILDKITE_PULL_REQUEST_BASE_BRANCH}
                  - GITHUB_PR_LABELS=${GITHUB_PR_LABELS}

  - label: ":pipeline: Upload beats-xpack-winlogbeat"
    if: build.pull_request.id == null
    command: "buildkite-agent pipeline upload .buildkite/x-pack/pipeline.xpack.winlogbeat.yml"

  - label: "Trigger Deploy/K8S"
    if: build.pull_request.id != null
    plugins:
      - monorepo-diff#v1.0.1:
          diff: "git diff --name-only origin/${GITHUB_PR_TARGET_BRANCH}...HEAD"
          interpolation: false
          watch:
            - path:
                - .buildkite/deploy/kubernetes/**
                - .buildkite/hooks/
                - .buildkite/scripts
                - deploy/kubernetes/**
                - metricbeat/module/kubernetes/**
                - libbeat/docs/version.asciidoc
              config:
                label: ":pipeline: Upload deploy-k8s"
                command: "buildkite-agent pipeline upload .buildkite/deploy/kubernetes/deploy-k8s-pipeline.yml"
                env:
                  - BUILDKITE_PULL_REQUEST=${BUILDKITE_PULL_REQUEST}
                  - BUILDKITE_PULL_REQUEST_BASE_BRANCH=${BUILDKITE_PULL_REQUEST_BASE_BRANCH}
                  - GITHUB_PR_LABELS=${GITHUB_PR_LABELS}

  - label: ":pipeline: Upload deploy-k8s"
    if: build.pull_request.id == null
    command: "buildkite-agent pipeline upload .buildkite/deploy/kubernetes/deploy-k8s-pipeline.yml"

  - label: "Trigger Libbeat"
    if: build.pull_request.id != null
    plugins:
      - monorepo-diff#v1.0.1:
          diff: "git diff --name-only origin/${GITHUB_PR_TARGET_BRANCH}...HEAD"
          interpolation: false
          watch:
            - path:
                - libbeat/
                - .buildkite/libbeat/pipeline.libbeat.yml
                - .buildkite/scripts
                - .buildkite/hooks
                #OSS
                - go.mod
                - pytest.ini
                - dev-tools/
                - testing/
              config:
                label: ":pipeline: Upload beats-libbeat"
                command: "buildkite-agent pipeline upload .buildkite/libbeat/pipeline.libbeat.yml"
                env:
                  - BUILDKITE_PULL_REQUEST=${BUILDKITE_PULL_REQUEST}
                  - BUILDKITE_PULL_REQUEST_BASE_BRANCH=${BUILDKITE_PULL_REQUEST_BASE_BRANCH}
                  - GITHUB_PR_LABELS=${GITHUB_PR_LABELS}

  - label: ":pipeline: Upload beats-libbeat"
    if: build.pull_request.id == null
    command: "buildkite-agent pipeline upload .buildkite/libbeat/pipeline.libbeat.yml"

  - label: "Trigger x-pack/libbeat"
    if: build.pull_request.id != null
    plugins:
      - monorepo-diff#v1.0.1:
          diff: "git diff --name-only origin/${GITHUB_PR_TARGET_BRANCH}...HEAD"
          interpolation: false
          watch:
            - path:
                - libbeat/
                - x-pack/libbeat/
                - .buildkite/x-pack/pipeline.xpack.libbeat.yml
                - .buildkite/scripts
                - .buildkite/hooks
                # x-pack
                - go.mod
                - pytest.ini
                - dev-tools/
                - libbeat/
                - testing/
              config:
                label: ":pipeline: Upload beats-xpack-libbeat"
                command: "buildkite-agent pipeline upload .buildkite/x-pack/pipeline.xpack.libbeat.yml"
                env:
                  - BUILDKITE_PULL_REQUEST=${BUILDKITE_PULL_REQUEST}
                  - BUILDKITE_PULL_REQUEST_BASE_BRANCH=${BUILDKITE_PULL_REQUEST_BASE_BRANCH}
                  - GITHUB_PR_LABELS=${GITHUB_PR_LABELS}

  - label: ":pipeline: Upload beats-xpack-libbeat"
    if: build.pull_request.id == null
    command: "buildkite-agent pipeline upload .buildkite/x-pack/pipeline.xpack.libbeat.yml"

  - label: "Trigger x-pack/auditbeat"
    if: build.pull_request.id != null
    plugins:
      - monorepo-diff#v1.0.1:
          diff: "git diff --name-only origin/${GITHUB_PR_TARGET_BRANCH}...HEAD"
          interpolation: false
          watch:
            - path:
                - auditbeat/
                - x-pack/auditbeat/
                - .buildkite/x-pack/pipeline.xpack.auditbeat.yml
                - .buildkite/scripts/
                - .buildkite/hooks/
                # x-pack
                - go.mod
                - pytest.ini
                - dev-tools/
                - libbeat/
                - testing/
                - x-pack/libbeat/
              config:
                label: ":pipeline: Upload beats-xpack-auditbeat"
                command: "buildkite-agent pipeline upload .buildkite/x-pack/pipeline.xpack.auditbeat.yml"
                env:
                  - BUILDKITE_PULL_REQUEST=${BUILDKITE_PULL_REQUEST}
                  - BUILDKITE_PULL_REQUEST_BASE_BRANCH=${BUILDKITE_PULL_REQUEST_BASE_BRANCH}
                  - GITHUB_PR_LABELS=${GITHUB_PR_LABELS}

  - label: ":pipeline: Upload beats-xpack-auditbeat"
    if: build.pull_request.id == null
    command: "buildkite-agent pipeline upload .buildkite/x-pack/pipeline.xpack.auditbeat.yml"


  - label: "Trigger x-pack/heartbeat"
    if: build.pull_request.id != null
    plugins:
      - monorepo-diff#v1.0.1:
          diff: "git diff --name-only origin/${GITHUB_PR_TARGET_BRANCH}...HEAD"
          interpolation: false
          watch:
            - path:
                - heartbeat/
                - x-pack/heartbeat/
                - .buildkite/x-pack/pipeline.xpack.heartbeat.yml
                - .buildkite/scripts/
                - .buildkite/hooks/
                # x-pack
                - go.mod
                - pytest.ini
                - dev-tools/
                - libbeat/
                - testing/
                - x-pack/libbeat/
              config:
                label: ":pipeline: Upload beats-xpack-heartbeat"
                command: "buildkite-agent pipeline upload .buildkite/x-pack/pipeline.xpack.heartbeat.yml"
                env:
                  - BUILDKITE_PULL_REQUEST=${BUILDKITE_PULL_REQUEST}
                  - BUILDKITE_PULL_REQUEST_BASE_BRANCH=${BUILDKITE_PULL_REQUEST_BASE_BRANCH}
                  - GITHUB_PR_LABELS=${GITHUB_PR_LABELS}

  - label: ":pipeline: Upload beats-xpack-heartbeat"
    if: build.pull_request.id == null
    command: "buildkite-agent pipeline upload .buildkite/x-pack/pipeline.xpack.heartbeat.yml"

  - label: "Trigger x-pack/packetbeat"
    if: build.pull_request.id != null
    plugins:
      - monorepo-diff#v1.0.1:
          diff: "git diff --name-only origin/${GITHUB_PR_TARGET_BRANCH}...HEAD"
          interpolation: false
          watch:
            - path:
                - packetbeat/
                - x-pack/packetbeat/
                - .buildkite/x-pack/pipeline.xpack.packetbeat.yml
                - .buildkite/scripts/
                - .buildkite/hooks/
                # x-pack
                - go.mod
                - pytest.ini
                - dev-tools/
                - libbeat/
                - testing/
                - x-pack/libbeat/
              config:
                trigger: "beats-xpack-packetbeat"
                build:
                  commit: "${BUILDKITE_COMMIT}"
                  branch: "${BUILDKITE_BRANCH}"
                  env:
                    - BUILDKITE_PULL_REQUEST=${BUILDKITE_PULL_REQUEST}
                    - BUILDKITE_PULL_REQUEST_BASE_BRANCH=${BUILDKITE_PULL_REQUEST_BASE_BRANCH}
                    - GITHUB_PR_LABELS=${GITHUB_PR_LABELS}

  - label: "Triggering Build for x-pack/packetbeat"
    if: build.pull_request.id == null
    trigger: "beats-xpack-packetbeat"
    build:
      commit: "${BUILDKITE_COMMIT}"
      branch: "${BUILDKITE_BRANCH}"

  - label: "Trigger Winlogbeat"
    if: build.pull_request.id != null
    plugins:
      - monorepo-diff#v1.0.1:
          diff: "git diff --name-only origin/${GITHUB_PR_TARGET_BRANCH}...HEAD"
          interpolation: false
          watch:
            - path:
                - winlogbeat/
                - .buildkite/winlogbeat/pipeline.winlogbeat.yml
                - .buildkite/scripts
                - .buildkite/hooks
                #OSS
                - go.mod
                - pytest.ini
                - dev-tools/
                - libbeat/
                - testing/
              config:
                label: ":pipeline: Upload beats-winlogbeat"
                command: "buildkite-agent pipeline upload .buildkite/winlogbeat/pipeline.winlogbeat.yml"
                env:
                  - BUILDKITE_PULL_REQUEST=${BUILDKITE_PULL_REQUEST}
                  - BUILDKITE_PULL_REQUEST_BASE_BRANCH=${BUILDKITE_PULL_REQUEST_BASE_BRANCH}
                  - GITHUB_PR_LABELS=${GITHUB_PR_LABELS}

  - label: ":pipeline: Upload beats-winlogbeat"
    if: build.pull_request.id == null
    command: "buildkite-agent pipeline upload .buildkite/winlogbeat/pipeline.winlogbeat.yml"

  - label: "Trigger Packetbeat"
    if: build.pull_request.id != null
    plugins:
      - monorepo-diff#v1.0.1:
          diff: "git diff --name-only origin/${GITHUB_PR_TARGET_BRANCH}...HEAD"
          interpolation: false
          watch:
            - path:
                - packetbeat/
                - .buildkite/packetbeat/pipeline.packetbeat.yml
                - .buildkite/scripts/
                - .buildkite/hooks/
                #OSS
                - go.mod
                - pytest.ini
                - dev-tools/
                - libbeat/
                - testing/
              config:
                label: ":pipeline: Upload beats-packetbeat"
                command: "buildkite-agent pipeline upload .buildkite/packetbeat/pipeline.winlogbeat.yml"
                env:
                  - BUILDKITE_PULL_REQUEST=${BUILDKITE_PULL_REQUEST}
                  - BUILDKITE_PULL_REQUEST_BASE_BRANCH=${BUILDKITE_PULL_REQUEST_BASE_BRANCH}
                  - GITHUB_PR_LABELS=${GITHUB_PR_LABELS}

  - label: ":pipeline: Upload beats-packetbeat"
    if: build.pull_request.id == null
    command: "buildkite-agent pipeline upload .buildkite/packetbeat/pipeline.packetbeat.yml"

  - label: "Trigger Agentbeat"
    if: build.pull_request.id != null
    plugins:
      - monorepo-diff#v1.0.1:
          diff: "git diff --name-only origin/${GITHUB_PR_TARGET_BRANCH}...HEAD"
          interpolation: false
          watch:
            - path:
                - auditbeat/
                - filebeat/
                - heartbeat/
                - metricbeat/
                - osquerybeat/
                - packetbeat/

                - x-pack/agentbeat/
                - x-pack/auditbeat/
                - x-pack/filebeat/
                - x-pack/heartbeat/
                - x-pack/metricbeat/
                - x-pack/osquerybeat/
                - x-pack/packetbeat/

                - .buildkite/x-pack/pipeline.xpack.agentbeat.yml
                - .buildkite/scripts/
                - .buildkite/hooks/
                #OSS
                - go.mod
                - pytest.ini
                - dev-tools/
                - libbeat/
                - testing/
              config:
                label: ":pipeline: Upload beats-xpack-agentbeat"
                command: "buildkite-agent pipeline upload .buildkite/x-pack/pipeline.xpack.agentbeat.yml"
                env:
                  - BUILDKITE_PULL_REQUEST=${BUILDKITE_PULL_REQUEST}
                  - BUILDKITE_PULL_REQUEST_BASE_BRANCH=${BUILDKITE_PULL_REQUEST_BASE_BRANCH}
                  - GITHUB_PR_LABELS=${GITHUB_PR_LABELS}

  - label: ":pipeline: Upload beats-xpack-agentbeat"
    if: build.pull_request.id == null
    command: "buildkite-agent pipeline upload .buildkite/x-pack/pipeline.xpack.agentbeat.yml"
