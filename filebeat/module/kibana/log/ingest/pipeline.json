{
    "description": "Pipeline for parsing Kibana logs",
    "on_failure": [
        {
            "set": {
                "field": "error.message",
                "value": "{{ _ingest.on_failure_message }}"
            }
        }
    ],
    "processors": [
        {
            "rename": {
                "field": "@timestamp",
                "target_field": "event.created"
            }
        },
        {
            "rename": {
                "field": "json",
                "target_field": "kibana.log.meta"
            }
        },
        {
            "date": {
                "field": "kibana.log.meta.@timestamp",
                "formats": [
                    "ISO8601"
                ],
                "target_field": "@timestamp"
            }
        },
        {
            "remove": {
                "field": "kibana.log.meta.@timestamp"
            }
        },
        {
            "rename": {
                "field": "kibana.log.meta.message",
                "target_field": "message"
            }
        },
        {
            "rename": {
                "field": "kibana.log.meta.state",
                "ignore_missing": true,
                "target_field": "kibana.log.state"
            }
        },
        {
            "rename": {
                "field": "kibana.log.meta.pid",
                "target_field": "process.pid"
            }
        },
        {
            "rename": {
                "field": "kibana.log.meta.tags",
                "target_field": "kibana.log.tags"
            }
        },
        {
            "rename": {
                "field": "kibana.log.meta.res.statusCode",
                "ignore_missing": true,
                "target_field": "http.response.status_code"
            }
        },
        {
            "rename": {
                "field": "kibana.log.meta.res.responseTime",
                "ignore_missing": true,
                "target_field": "temp.duration"
            }
        },
        {
            "script": {
                "if": "ctx.temp?.duration != null",
                "lang": "painless",
                "params": {
                    "scale": 1000000
                },
                "source": "ctx.event.duration = Math.round(ctx.temp.duration * params.scale)"
            }
        },
        {
            "remove": {
                "field": "temp.duration",
                "ignore_missing": true
            }
        },
        {
            "rename": {
                "field": "kibana.log.meta.res.contentLength",
                "ignore_missing": true,
                "target_field": "http.response.body.bytes"
            }
        },
        {
            "rename": {
                "field": "kibana.log.meta.req.method",
                "ignore_missing": true,
                "target_field": "http.request.method"
            }
        },
        {
            "rename": {
                "field": "kibana.log.meta.req.headers.referer",
                "ignore_missing": true,
                "target_field": "http.request.referrer"
            }
        },
        {
            "rename": {
                "field": "kibana.log.meta.req.headers.user-agent",
                "ignore_missing": true,
                "target_field": "user_agent.original"
            }
        },
        {
            "rename": {
                "field": "kibana.log.meta.req.remoteAddress",
                "ignore_missing": true,
                "target_field": "source.address"
            }
        },
        {
            "set": {
                "field": "source.ip",
                "if": "ctx.source?.address != null",
                "value": "{{source.address}}"
            }
        },
        {
            "rename": {
                "field": "kibana.log.meta.req.url",
                "ignore_missing": true,
                "target_field": "url.original"
            }
        },
        {
            "remove": {
                "field": "kibana.log.meta.req.referer",
                "ignore_missing": true
            }
        },
        {
            "remove": {
                "field": "kibana.log.meta.statusCode",
                "ignore_missing": true
            }
        },
        {
            "remove": {
                "field": "kibana.log.meta.method",
                "ignore_missing": true
            }
        },
        {
            "append": {
                "field": "service.name",
                "value": "kibana"
            }
        }
    ]
}