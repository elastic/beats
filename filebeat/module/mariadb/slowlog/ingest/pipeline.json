{
  "description": "Pipeline for parsing MariaDB slow logs.",
  "processors": [{
    "grok": {
      "field": "message",
      "patterns":[
        "^# Time: (?<mariadb.slowlog.time>%{NUMBER}%{SPACE}%{TIME})(.|\r|\n)*# User@Host: %{USER:mariadb.slowlog.user}\\[%{USER:mariadb.slowlog.current_user}\\] @ %{HOSTNAME:mariadb.slowlog.client_host}? \\[%{IP:mariadb.slowlog.client_ip}?\\](.|\r|\n)*# Thread_id:%{SPACE}%{NUMBER:mariadb.slowlog.thread_id}  Schema: %{WORD:mariadb.slowlog.schema}?  QC_hit: %{WORD:mariadb.slowlog.query_cache_hit}(.|\r|\n)*# Query_time: %{NUMBER:mariadb.slowlog.query_time.sec}  Lock_time: %{NUMBER:mariadb.slowlog.lock_time}  Rows_sent: %{NUMBER:mariadb.slowlog.rows_sent}  Rows_examined: %{NUMBER:mariadb.slowlog.rows_examined}(.|\r|\n)*SET timestamp=%{NUMBER:mariadb.slowlog.timestamp};(.|\n)%{GREEDYMULTILINE:mariadb.slowlog.query}"
        ],
      "pattern_definitions" : {
        "GREEDYMULTILINE" : "(.|\n)*"
      },
      "ignore_missing": true
    }
  }, {
    "remove":{
      "field": "message"
    }
  }, {
    "date": {
      "field": "mariadb.slowlog.timestamp",
      "target_field": "@timestamp",
      "formats": ["UNIX"],
      "ignore_failure": true
    }
  }, {
    "gsub": {
      "field": "mariadb.slowlog.query",
       "pattern": "\n# Time: [0-9]+ [0-9][0-9]:[0-9][0-9]:[0-9][0-9](\\.[0-9]+)?$",
       "replacement": "",
       "ignore_failure": true
    }
  }],
  "on_failure" : [{
    "set" : {
      "field" : "error.message",
      "value" : "{{ _ingest.on_failure_message }}"
    }
  }]
}
