{
    "description": "Pipeline for parsing IIS error logs. Requires the geoip plugin.",
    "on_failure": [
        {
            "set": {
                "field": "error.message",
                "value": "{{ _ingest.on_failure_message }}"
            }
        }
    ],
    "processors": [
        {
            "grok": {
                "field": "message",
                "ignore_missing": true,
                "patterns": [
                    "%{TIMESTAMP_ISO8601:iis.error.time} %{IPORHOST:source.address} %{NUMBER:source.port:long} %{IPORHOST:destination.address} %{IPORHOST:destination.port:long} (?:HTTP/%{NUMBER:http.version}|-) (?:%{WORD:http.request.method}|-) (?:%{URIPATHPARAM:url.original}|-)(?: -)? (?:%{NUMBER:http.response.status_code:long}|-) (?:%{NUMBER}|-) (?:%{NOTSPACE:iis.error.reason_phrase}|-) (?:%{NOTSPACE:iis.error.queue_name}|-)"
                ]
            }
        },
        {
            "remove": {
                "field": "message"
            }
        },
        {
            "rename": {
                "field": "@timestamp",
                "target_field": "event.created"
            }
        },
        {
            "date": {
                "field": "iis.error.time",
                "formats": [
                    "yyyy-MM-dd HH:mm:ss"
                ],
                "target_field": "@timestamp"
            }
        },
        {
            "remove": {
                "field": "iis.error.time"
            }
        },
        {
            "grok": {
                "field": "destination.address",
                "pattern_definitions": {
                    "NOZONEIP": "[^%]*"
                },
                "patterns": [
                    "%{NOZONEIP:destination.ip}"
                ]
            }
        },
        {
            "grok": {
                "field": "source.address",
                "pattern_definitions": {
                    "NOZONEIP": "[^%]*"
                },
                "patterns": [
                    "%{NOZONEIP:source.ip}"
                ]
            }
        },
        {
            "geoip": {
                "field": "source.ip",
                "ignore_failure": true,
                "target_field": "source.geo"
            }
        }
    ]
}