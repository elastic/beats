{
    "description": "Pipeline for parsing system authorisation/secure logs",
    "processors": [
        { "set": { "field": "event.kind", "value": "event" } },

        {
            "grok": {
                "field": "message",
                "ignore_missing": true,
                "pattern_definitions" : {
                    "GREEDYMULTILINE" : "(.|\n)*"
                },
                "patterns": [
                    "^%{SYSLOGTIMESTAMP:system.auth.timestamp} %{SYSLOGHOST:host.hostname} %{DATA:process.name}(?:\\[%{POSINT:process.pid:long}\\])?: +%{GREEDYMULTILINE:message}",
                    "^%{SYSLOGTIMESTAMP:system.auth.timestamp} %{DATA:process.name}(?:\\[%{POSINT:process.pid:long}\\])?: +%{GREEDYMULTILINE:message}"
                ]
            }
        },

        {
            "grok": {
                "field": "message",
                "ignore_missing": true,
                "ignore_failure": true,
                "patterns": [
                    "^%{DATA:system.auth.ssh.action} %{DATA:system.auth.ssh.method} for (invalid user )?%{DATA:user.name} from %{IPORHOST:source.ip} port %{NUMBER:source.port:long} ssh2(: %{GREEDYDATA:system.auth.ssh.signature})?",
                    "^%{DATA:system.auth.ssh.action} user %{DATA:user.name} from %{IPORHOST:source.ip}",
                    "^Did not receive identification string from %{IPORHOST:system.auth.ssh.dropped_ip}"
                ]
            }
        },

        {
            "grok": {
                "field": "message",
                "ignore_missing": true,
                "ignore_failure": true,
                "patterns": [
                    "^%{DATA:user.name} :( %{DATA:system.auth.sudo.error} ;)? TTY=%{DATA:system.auth.sudo.tty} ; PWD=%{DATA:system.auth.sudo.pwd} ; USER=%{DATA:system.auth.sudo.user} ; COMMAND=%{GREEDYDATA:system.auth.sudo.command}",
                    "^new group: name=%{DATA:group.name}, GID=%{NUMBER:group.id:long}",
                    "^new user: name=%{DATA:user.name}, UID=%{NUMBER:user.id:long}, GID=%{NUMBER:group.id:long}, home=%{DATA:system.auth.useradd.home}, shell=%{DATA:system.auth.useradd.shell}$"
                ]
            }
        },

        {
            "set": {
                "field": "event.category",
                "value": "authentication",
                "if": "ctx.containsKey('process') && ctx.process.containsKey('name') && ctx.process.name == 'sshd'"
            }
        },
        {
            "set": {
                "field": "event.action",
                "value": "ssh_login",
                "if": "ctx.event.containsKey('category') && ctx.event.category == 'authentication'"
            }
        },
        {
            "set": {
                "field": "event.outcome",
                "value": "success",
                "if": "ctx.event.containsKey('action') && ctx.event.action == 'ssh_login' && ctx.system.auth.containsKey('ssh') && ctx.system.auth.ssh.containsKey('action') && ctx.system.auth.ssh.action == 'Accepted'"
            }
        },
        {
            "set": {
                "field": "event.outcome",
                "value": "failure",
                "if": "ctx.event.containsKey('action') && ctx.event.action == 'ssh_login' && ctx.system.auth.containsKey('ssh') && ((ctx.system.auth.ssh.containsKey('action') && ctx.system.auth.ssh.action == 'Failed') || (ctx.system.auth.ssh.containsKey('dropped_ip')))"
            }
        },

        {
            "set": {
                "field": "source.ip",
                "value": "{{system.auth.ssh.dropped_ip}}",
                "if": "ctx.system.auth.containsKey('ssh') && ctx.system.auth.ssh.containsKey('dropped_ip')"
            }
        },
        {
            "date": {
                "field": "system.auth.timestamp",
                "target_field": "@timestamp",
                "formats": [
                    "MMM  d HH:mm:ss",
                    "MMM dd HH:mm:ss"
                ],
                {< if .convert_timezone >}"timezone": "{{ beat.timezone }}",{< end >}
                "ignore_failure": true
            }
        },
        {
            "remove": {
                "field": "system.auth.timestamp"
            }
        },
        {
            "geoip": {
                "field": "source.ip",
                "target_field": "source.geo",
                "ignore_failure": true
            }
        }
    ],
    "on_failure" : [{
        "set" : {
            "field" : "error.message",
            "value" : "{{ _ingest.on_failure_message }}"
        }
    }]
}
