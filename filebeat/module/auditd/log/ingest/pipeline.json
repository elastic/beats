{
    "description": "Pipeline for parsing Linux auditd logs",
    "on_failure": [
        {
            "set": {
                "field": "error.message",
                "value": "{{ _ingest.on_failure_message }}"
            }
        }
    ],
    "processors": [
        {
            "grok": {
                "field": "message",
                "pattern_definitions": {
                    "AUDIT_KEY_VALUES": "%{WORD}=%{GREEDYDATA}",
                    "AUDIT_PREFIX": "%{AUDIT_TYPE} msg=audit\\(%{NUMBER:auditd.log.epoch}:%{NUMBER:auditd.log.sequence}\\):(%{DATA})?",
                    "AUDIT_TYPE": "^type=%{NOTSPACE:auditd.log.record_type}"
                },
                "patterns": [
                    "%{AUDIT_PREFIX} %{AUDIT_KEY_VALUES:auditd.log.kv} old auid=%{NUMBER:auditd.log.old_auid} new auid=%{NUMBER:auditd.log.new_auid} old ses=%{NUMBER:auditd.log.old_ses} new ses=%{NUMBER:auditd.log.new_ses}",
                    "%{AUDIT_PREFIX} %{AUDIT_KEY_VALUES:auditd.log.kv} msg=['\"](%{DATA:auditd.log.msg}\\s+)?%{AUDIT_KEY_VALUES:auditd.log.sub_kv}['\"]",
                    "%{AUDIT_PREFIX} %{AUDIT_KEY_VALUES:auditd.log.kv}",
                    "%{AUDIT_PREFIX}",
                    "%{AUDIT_TYPE} %{AUDIT_KEY_VALUES:auditd.log.kv}"
                ]
            }
        },
        {
            "kv": {
                "field": "auditd.log.kv",
                "field_split": "\\s+",
                "target_field": "auditd.log",
                "value_split": "="
            }
        },
        {
            "kv": {
                "field": "auditd.log.sub_kv",
                "field_split": "\\s+",
                "ignore_missing": true,
                "target_field": "auditd.log",
                "value_split": "="
            }
        },
        {
            "remove": {
                "field": "auditd.log.kv",
                "ignore_failure": true
            }
        },
        {
            "remove": {
                "field": "auditd.log.sub_kv",
                "ignore_failure": true
            }
        },
        {
            "remove": {
                "field": "message",
                "ignore_failure": true
            }
        },
        {
            "date": {
                "field": "auditd.log.epoch",
                "formats": [
                    "UNIX"
                ],
                "ignore_failure": true,
                "target_field": "@timestamp"
            }
        },
        {
            "remove": {
                "field": "auditd.log.epoch",
                "ignore_failure": true
            }
        },
        {
            "convert": {
                "field": "auditd.log.sequence",
                "ignore_missing": true,
                "type": "integer"
            }
        },
        {
            "script": {
                "lang": "painless",
                "params": {
                    "double_quote": "\"",
                    "single_quote": "'"
                },
                "source": "    String trimQuotes(def singleQuote, def doubleQuote, def v) {\n        if (v.startsWith(singleQuote) || v.startsWith(doubleQuote)) {\n          v = v.substring(1, v.length());\n        }\n        if (v.endsWith(singleQuote) || v.endsWith(doubleQuote)) {\n          v = v.substring(0, v.length()-1);\n        }  \n        return v;\n    }\n    \n    boolean isHexAscii(String v) {\n      def len = v.length();\n      if (len == 0 || len % 2 != 0) {\n        return false; \n      }\n  \n      for (int i = 0 ; i \u003c len ; i++) {\n        if (Character.digit(v.charAt(i), 16) == -1) {\n          return false;\n        }\n      }\n\n      return true;\n    }\n    \n    String convertHexToString(String hex) {\n\t    StringBuilder sb = new StringBuilder();\n\n      for (int i=0; i \u003c hex.length() - 1; i+=2) {\n          String output = hex.substring(i, (i + 2));\n          int decimal = Integer.parseInt(output, 16);\n          sb.append((char)decimal);\n      }\n\n      return sb.toString();\n    }\n    \n    def possibleHexKeys = ['exe', 'cmd'];\n    \n    def audit = ctx.auditd.get(\"log\");\n    Iterator entries = audit.entrySet().iterator();\n    while (entries.hasNext()) {\n      def e = entries.next();\n      def k = e.getKey();\n      def v = e.getValue(); \n\n      // Remove entries whose value is ?\n      if (v == \"?\" || v == \"(null)\" || v == \"\") {\n        entries.remove();\n        continue;\n      }\n      \n      // Convert hex values to ASCII.\n      if (possibleHexKeys.contains(k) \u0026\u0026 isHexAscii(v)) {\n        v = convertHexToString(v);\n        audit.put(k, v);\n      }\n      \n      // Trim quotes.\n      if (v instanceof String) {\n        v = trimQuotes(params.single_quote, params.double_quote, v);\n        audit.put(k, v);\n      }\n      \n      // Convert arch.\n      if (k == \"arch\" \u0026\u0026 v == \"c000003e\") {\n        audit.put(k, \"x86_64\");\n      }\n    }"
            }
        },
        {
            "rename": {
                "field": "auditd.log.arch",
                "ignore_failure": true,
                "target_field": "host.architecture"
            }
        },
        {
            "rename": {
                "field": "auditd.log.acct",
                "ignore_failure": true,
                "target_field": "user.name"
            }
        },
        {
            "rename": {
                "field": "auditd.log.uid",
                "ignore_failure": true,
                "target_field": "user.id"
            }
        },
        {
            "rename": {
                "field": "auditd.log.gid",
                "ignore_failure": true,
                "target_field": "user.group.id"
            }
        },
        {
            "rename": {
                "field": "auditd.log.agid",
                "ignore_failure": true,
                "target_field": "user.audit.group.id"
            }
        },
        {
            "rename": {
                "field": "auditd.log.auid",
                "ignore_failure": true,
                "target_field": "user.audit.id"
            }
        },
        {
            "rename": {
                "field": "auditd.log.fsgid",
                "ignore_failure": true,
                "target_field": "user.filesystem.group.id"
            }
        },
        {
            "rename": {
                "field": "auditd.log.fsuid",
                "ignore_failure": true,
                "target_field": "user.filesystem.id"
            }
        },
        {
            "rename": {
                "field": "auditd.log.egid",
                "ignore_failure": true,
                "target_field": "user.effective.group.id"
            }
        },
        {
            "rename": {
                "field": "auditd.log.euid",
                "ignore_failure": true,
                "target_field": "user.effective.id"
            }
        },
        {
            "rename": {
                "field": "auditd.log.sgid",
                "ignore_failure": true,
                "target_field": "user.saved.group.id"
            }
        },
        {
            "rename": {
                "field": "auditd.log.suid",
                "ignore_failure": true,
                "target_field": "user.saved.id"
            }
        },
        {
            "rename": {
                "field": "auditd.log.ogid",
                "ignore_failure": true,
                "target_field": "user.owner.group.id"
            }
        },
        {
            "rename": {
                "field": "auditd.log.ouid",
                "ignore_failure": true,
                "target_field": "user.owner.id"
            }
        },
        {
            "rename": {
                "field": "auditd.log.comm",
                "ignore_failure": true,
                "target_field": "process.name"
            }
        },
        {
            "rename": {
                "field": "auditd.log.exe",
                "ignore_failure": true,
                "target_field": "process.executable"
            }
        },
        {
            "rename": {
                "field": "auditd.log.pid",
                "ignore_failure": true,
                "target_field": "process.pid"
            }
        },
        {
            "rename": {
                "field": "auditd.log.ppid",
                "ignore_failure": true,
                "target_field": "process.ppid"
            }
        },
        {
            "convert": {
                "field": "process.pid",
                "ignore_missing": true,
                "type": "long"
            }
        },
        {
            "convert": {
                "field": "process.ppid",
                "ignore_missing": true,
                "type": "long"
            }
        },
        {
            "rename": {
                "field": "auditd.log.cmd",
                "ignore_failure": true,
                "target_field": "process.args"
            }
        },
        {
            "split": {
                "field": "process.args",
                "ignore_failure": true,
                "separator": "\\s+"
            }
        },
        {
            "rename": {
                "field": "auditd.log.terminal",
                "ignore_failure": true,
                "target_field": "user.terminal"
            }
        },
        {
            "rename": {
                "field": "auditd.log.msg",
                "ignore_failure": true,
                "target_field": "message"
            }
        },
        {
            "rename": {
                "field": "auditd.log.res",
                "ignore_failure": true,
                "target_field": "event.outcome"
            }
        },
        {
            "rename": {
                "field": "auditd.log.record_type",
                "ignore_failure": true,
                "target_field": "event.action"
            }
        },
        {
            "lowercase": {
                "field": "event.action",
                "ignore_failure": true
            }
        },
        {
            "rename": {
                "field": "auditd.log.src",
                "ignore_failure": true,
                "target_field": "source.address"
            }
        },
        {
            "rename": {
                "field": "auditd.log.dst",
                "ignore_failure": true,
                "target_field": "destination.address"
            }
        },
        {
            "grok": {
                "field": "source.address",
                "ignore_failure": true,
                "patterns": [
                    "^%{IP:source.ip}$"
                ]
            }
        },
        {
            "geoip": {
                "field": "source.ip",
                "ignore_failure": true,
                "target_field": "source.geo"
            }
        }
    ]
}